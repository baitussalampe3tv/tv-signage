<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>TV Signage (Mobile) – Masjid</title>
<style>
  :root{
    --bg1:#E8FFF7; --bg2:#D9F7F0;
    --panel:#F4FBF8; --border:#B6E2D5;
    --gold:#C9A23C; --text:#102A27; --muted:#3A5F58;
    --tickerBg:#0B1C53; --tickerText:#FFFFFF;
    --shadow:0 10px 28px rgba(0,0,0,.16);
  }
  body.theme-emerald{
    --bg1:#0d2d28; --bg2:#134238; --panel:#123a32; --border:#2f6b5e;
    --gold:#e8c15a; --text:#EAF7F3; --muted:#bfe4d8;
    --tickerBg:#0f3b34; --tickerText:#fdfdfd;
    --shadow:0 14px 36px rgba(0,0,0,.28);
  }
  body.theme-gold{
    --bg1:#fff7e0; --bg2:#ffefc6; --panel:#fff8e8; --border:#f0db9a;
    --gold:#d5a921; --text:#2b240f; --muted:#5b4d1d;
    --tickerBg:#7a5a12; --tickerText:#fffaf0;
    --shadow:0 14px 36px rgba(0,0,0,.18);
  }

  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text);font-family:Inter,"Segoe UI",Roboto,system-ui,Arial,sans-serif}
  .page{min-height:100%; display:flex; flex-direction:column}
  .content{padding:12px 12px 72px}

  /* HEADER sticky */
  .topbar{position:sticky; top:0; z-index:10; padding:10px 12px; backdrop-filter:blur(8px);
    background:linear-gradient(180deg, rgba(255,255,255,.22), rgba(255,255,255,.08)); border-bottom:1px solid var(--border)}
  .brand{display:flex; gap:10px; align-items:center; min-width:0}
  .brand img{height:34px; flex:0 0 auto}
  .brand .txt{line-height:1.05; min-width:0}
  .brand .name{font-size:16px; font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .brand .sub{font-size:12px; font-weight:700; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

  /* WAKTU SHOLAT – rapi grid 1fr|auto */
  .prayer{display:flex; flex-direction:column; gap:10px; padding:12px; margin:12px 12px 0; background:linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.08));
    border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow); width:calc(100% - 24px)}
  .phdr{font-weight:900; font-size:15px}
  .pt{display:flex; flex-direction:column; gap:6px; width:100%}
  .prow{display:grid; grid-template-columns: 1fr auto; align-items:center; gap:10px; width:100%}
  .name{color:var(--muted); font-weight:800; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
  .time{font-weight:900; min-width:56px; text-align:right}
  .nextRow{display:grid; grid-template-columns: 1fr auto; align-items:center; gap:10px; padding-top:8px; border-top:1px dashed var(--border); width:100%}
  .next{font-weight:900; color:var(--gold); overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
  .cd{font-weight:900; text-align:right}

  /* CARD umum */
  .card{margin:12px; background:var(--panel); border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow); overflow:hidden}

  /* SCHEDULE */
  .scard{padding:16px; color:#fff; background:linear-gradient(180deg, rgba(0,0,0,.20), rgba(0,0,0,.10));}
  .stitle{margin:0 0 10px; text-align:center; color:var(--gold); font-weight:900; font-size:clamp(18px,5.4vw,26px)}
  .slist{display:grid; gap:10px}
  .srow{display:grid; grid-template-columns: 1fr; gap:6px; background:rgba(0,0,0,.22); border:1px solid rgba(255,255,255,.18); border-radius:10px; padding:10px 12px}
  .srow .time{font-weight:900; font-size:clamp(14px,4.2vw,18px)}
  .srow .topic{font-weight:800; font-size:clamp(14px,4vw,18px)}
  .srow .ust{font-weight:700; opacity:.95; font-size:clamp(13px,3.8vw,17px)}

  /* FINANCE */
  .fcard{padding:16px; color:#fff; background:linear-gradient(180deg, rgba(0,0,0,.20), rgba(0,0,0,.10));}
  .ftitle{margin:0 0 10px; text-align:center; color:var(--gold); font-weight:900; font-size:clamp(18px,5.4vw,26px)}
  #finCanvas{width:100%; height:48vh; background:rgba(0,0,0,.18); border-radius:10px}

  /* QUOTE */
  .qcard{color:#fff; padding:18px 16px;
    background:
      radial-gradient(700px 240px at 30% 0%, rgba(231, 196, 94, .25), transparent 60%),
      linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.55)),
      url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="600" height="300" viewBox="0 0 600 300"><defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="%23c79d2b"/><stop offset="1" stop-color="%23e6c86a"/></linearGradient></defs><g fill="none" stroke="url(%23g)" stroke-opacity=".2"><path d="M0 60 C150 120 450 0 600 60" /><path d="M0 140 C150 200 450 80 600 140" /><path d="M0 220 C150 280 450 160 600 220" /></g></svg>') center/cover no-repeat;
  }
  .qtext{margin:0 0 8px; font-weight:900; color:var(--gold); text-shadow:0 2px 6px rgba(0,0,0,.6); font-size:clamp(18px,5.5vw,28px); text-align:center}
  .qsrc{margin:0; text-align:center; color:#fff; opacity:.95; font-weight:800; font-size:clamp(14px,4.4vw,18px)}

  /* VIDEO */
  .vwrap{position:relative; width:100%; height:0; padding-bottom:56.25%; background:#000}
  .vwrap > *{position:absolute; inset:0; width:100%; height:100%; display:block; border:0}

  /* GAMBAR */
  .imgBox{width:100%; background:#00000010}
  .imgBox img{display:block; width:100%; height:auto}
  .capBox{padding:10px 12px}
  .capTitle{margin:0 0 4px; font-size:clamp(16px,4.4vw,22px); font-weight:900}
  .capDesc{margin:0; font-size:clamp(13px,3.8vw,18px); font-weight:600; color:#2b2b2b}

  /* TICKER fixed */
  .ticker{position:fixed; left:0; right:0; bottom:0; z-index:12; background:var(--tickerBg); color:var(--tickerText); min-height:44px; overflow:hidden}
  .tkInner{white-space:nowrap; will-change:transform; padding:0 100vw 0 0; display:inline-block}
  .tkText{display:inline-block; padding:12px 16px; font-size:clamp(13px,3.6vw,16px); font-weight:800}

  /* QRIS floating (ambil dari JSON) */
  .qrisBox{
    position:fixed; left:12px; bottom:56px; z-index:13;
    background:var(--panel); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow);
    padding:8px; display:none; align-items:center; gap:8px;
  }
  .qrisBox.right{ left:auto; right:12px; }
  .qrisBox img{display:block; height:auto}
  .qrisBox .ttl{font-weight:900; font-size:13px; color:var(--text); max-width:42vw}
  .qrisBox .close{appearance:none; border:0; background:transparent; font-weight:900; font-size:16px; line-height:1; cursor:pointer; color:var(--muted)}
  @media (max-width:420px){
    .qrisBox{gap:6px}
    .qrisBox .ttl{font-size:12px}
  }
</style>
</head>
<body class="theme-gold">
<div class="page">

  <!-- HEADER -->
  <div class="topbar">
    <div class="brand">
      <img src="logo.png" alt="Logo">
      <div class="txt">
        <div class="name">Masjid Baitussalam</div>
        <div class="sub">Premier Estate 3</div>
      </div>
    </div>
  </div>

  <div class="content" id="content">
    <!-- WAKTU SHOLAT -->
    <section class="prayer" id="prayerBox">
      <div class="phdr">Waktu Sholat</div>
      <div class="pt" id="pt"></div>
      <div class="nextRow"><div class="next" id="next">Selanjutnya: -</div><div class="cd" id="cd">--:--:--</div></div>
    </section>

    <!-- Urutan: Schedule → Finance → Quote → Video → Foto -->
    <div id="secSchedule"></div>
    <div id="secFinance"></div>
    <div id="secQuotes"></div>
    <div id="secVideos"></div>
    <div id="secImages"></div>
  </div>

  <!-- TICKER -->
  <div class="ticker" id="ticker" style="display:none">
    <div class="tkInner" id="tkInner"><span class="tkText" id="tkText"></span></div>
  </div>

  <!-- QRIS floating (dari JSON) -->
  <div class="qrisBox" id="qrisBox">
    <img id="qrisImg" alt="QRIS">
    <div class="ttl" id="qrisTtl">Dukungan Infaq – Scan QRIS</div>
    <button class="close" id="qrisClose" aria-label="Tutup">×</button>
  </div>

</div>

<script>
(function(){
  const qs=new URLSearchParams(location.search);

  /* ===== Theme ===== */
  (function setTheme(){
    const th=(qs.get("theme")||"gold").toLowerCase();
    document.body.className = `theme-${["emerald","gold"].includes(th)?th:"gold"}`;
  })();

  /* ===== Params ===== */
  const configUrl=qs.get("config") || "signage.json";
  const refreshMin=parseFloat(qs.get("refreshMin")||"5");
  const tickerParam=qs.get("ticker");
  const showTickerQ=["1","true","yes","on"].includes((qs.get("showTicker")||"").toLowerCase());
  const tickerPauseSec = 2; // jeda 2 detik
  const tickerSpeed = parseFloat(qs.get("tickerSpeed")||"90");

  /* ===== Base path & cache-bust ===== */
  function baseOf(urlStr){
    try{ const u=new URL(urlStr, location.href); u.hash=""; u.search=""; return u.href.replace(/[^/]+$/,""); }
    catch(_){ return ""; }
  }
  const __configBase = baseOf(configUrl);
  const __bust = qs.get("t") || "";
  function resolveAsset(u){
    if(!u) return "";
    if(/^https?:\/\//i.test(u) || /^data:/i.test(u)) return u;
    if(u.startsWith("/")) return u;
    return __configBase ? (__configBase + u) : u;
  }
  function withBust(u){
    if(!__bust) return u;
    try{ const url=new URL(u, location.href); url.searchParams.set("v", __bust); return url.toString(); }
    catch(_){ return u + (u.includes("?")?"&":"?") + "v="+encodeURIComponent(__bust); }
  }

  /* ===== Elements ===== */
  const secSchedule=document.getElementById("secSchedule");
  const secFinance=document.getElementById("secFinance");
  const secQuotes =document.getElementById("secQuotes");
  const secVideos =document.getElementById("secVideos");
  const secImages =document.getElementById("secImages");

  const ticker=document.getElementById("ticker");
  const tkInner=document.getElementById("tkInner");
  const tkText=document.getElementById("tkText");

  const ptEl=document.getElementById("pt");
  const nextEl=document.getElementById("next");
  const cdEl=document.getElementById("cd");

  const qrisBox=document.getElementById("qrisBox");
  const qrisImg=document.getElementById("qrisImg");
  const qrisTtl=document.getElementById("qrisTtl");
  const qrisClose=document.getElementById("qrisClose");

  /* ===== Helpers ===== */
  function clear(el){ el.innerHTML=""; }
  function add(child,to){ to.appendChild(child); }
  function make(tag, cls){ const e=document.createElement(tag); if(cls) e.className=cls; return e; }

  function isYouTubeUrl(u){ return /(?:youtube\.com|youtu\.be)/i.test(u||""); }
  function extractYouTube(u){
    try{
      const url=new URL(u);
      let id="", start=0;
      const toSec=(t)=>{ if(!t) return 0; if(/^\d+$/.test(t)) return +t; let s=0; const h=/(\d+)h/i.exec(t); if(h)s+=+h[1]*3600; const m=/(\d+)m/i.exec(t); if(m)s+=+m[1]*60; const sc=/(\d+)s/i.exec(t); if(sc)s+=+sc[1]; return s; };
      if(url.hostname.includes("youtu.be")){ id=url.pathname.replace(/^\/+/,""); start=toSec(url.searchParams.get("t")); }
      else if(url.pathname.startsWith("/watch")){ id=url.searchParams.get("v")||""; start=toSec(url.searchParams.get("t")); }
      else if(url.pathname.startsWith("/embed/")){ id=url.pathname.split("/").pop(); start=toSec(url.searchParams.get("start")||url.searchParams.get("t")); }
      return id?{id,start}:null;
    }catch(_){ return null; }
  }

  /* ===== Builders ===== */
  function buildSchedule(list){
    if(!list || !list.length) return;
    const card=make('section','card scard');
    const t=make('h3','stitle'); t.textContent='Jadwal Kajian';
    const ul=make('div','slist');
    list.forEach(it=>{
      const row=make('div','srow');
      row.innerHTML=`<div class="time">${it.time||""}</div><div class="topic">${it.topic||""}</div><div class="ust">${it.ustadz||""}</div>`;
      ul.appendChild(row);
    });
    card.append(t,ul);
    add(card,secSchedule);
  }

  function wrapLines(ctx, text, maxWidth, maxLines){
    const words = String(text).split(/\s+/);
    const lines=[]; let cur="";
    for(const w of words){
      const test=(cur?cur+" ":"")+w;
      if(ctx.measureText(test).width <= maxWidth){ cur=test; }
      else{ if(cur) lines.push(cur); cur=w; if(lines.length>=maxLines-1) break; }
    }
    if(cur && lines.length<maxLines) lines.push(cur);
    return lines;
  }

  function drawFinance(canvas, fin){
    const dpr=window.devicePixelRatio||1;
    const w=canvas.clientWidth, h=Math.max(260,canvas.clientHeight||260);
    canvas.width=Math.floor(w*dpr); canvas.height=Math.floor(h*dpr);
    const ctx=canvas.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0); ctx.clearRect(0,0,w,h);

    const pad=18, labels=fin.labels||[], data=fin.data||[];
    const maxV=Math.max(1, ...data.map(v=>Math.abs(v)));
    const n=labels.length||1;
    const barW=(w-pad*2)/(n*1.7), gap=barW*0.7;
    const baseY=h-pad-36;
    const scale=(h-pad*2-58)/maxV;

    // grid
    ctx.strokeStyle="rgba(255,255,255,.22)"; ctx.lineWidth=1; ctx.beginPath();
    for(let i=0;i<=3;i++){ const y=pad+i*((baseY-pad)/3); ctx.moveTo(pad,y); ctx.lineTo(w-pad,y); }
    ctx.stroke();

    labels.forEach((lab,i)=>{
      const v=data[i]||0, bh=v*scale, x=pad+i*(barW+gap), y=baseY-bh;

      // bar
      ctx.fillStyle="#e8c15a"; ctx.fillRect(x,y,barW,bh);

      // nilai (atas)
      const valueFont = Math.max(13, Math.round(w/22));
      ctx.fillStyle="#e8c15a"; ctx.font = `bold ${valueFont}px Inter, Arial`; ctx.textAlign="center";
      ctx.fillText(formatRupiah(v), x+barW/2, Math.max(16,y-8));

      // label kategori (wrap 2 baris)
      const labelFont = Math.max(11, Math.round(barW/3.5));
      ctx.fillStyle="#fff"; ctx.font = `${labelFont}px Inter, Arial`;
      const maxWidth = barW*1.2;
      const lines = wrapLines(ctx, lab, maxWidth, 2);
      const startY = baseY + 18;
      if(lines.length===1){
        ctx.fillText(lines[0], x+barW/2, startY);
      }else{
        ctx.fillText(lines[0], x+barW/2, startY-6);
        ctx.fillText(lines[1], x+barW/2, startY+10);
      }
    });
  }

  function buildFinance(fin){
    if(!fin) return;
    const card=make('section','card fcard');
    const t=make('h3','ftitle'); t.textContent=fin.title||'Laporan Keuangan';
    const canvas=make('canvas'); canvas.id='finCanvas';
    card.append(t,canvas);
    add(card,secFinance);

    const redraw=()=>drawFinance(canvas, fin);
    // tunggu font agar ukuran akurat
    (document.fonts?document.fonts.ready:Promise.resolve()).then(()=>{ requestAnimationFrame(redraw); });
    // redraw saat resize (debounce)
    let rid=null; window.addEventListener('resize', ()=>{ clearTimeout(rid); rid=setTimeout(redraw, 120); });
  }

  function buildQuote(it){
    const card=make('section','card qcard');
    const h=make('p','qtext'); h.textContent=it.quote||'';
    const s=make('p','qsrc');  s.textContent=it.source||'';
    card.append(h,s); add(card,secQuotes);
  }

  function buildVideo(it){
    const card=make('section','card');
    const wrap=make('div','vwrap');
    if(isYouTubeUrl(it.video||"")){
      const ex=extractYouTube(it.video);
      if(ex){
        const src = `https://www.youtube-nocookie.com/embed/${ex.id}?autoplay=0&mute=0&controls=1&rel=0&playsinline=1&modestbranding=1&iv_load_policy=3&cc_load_policy=1&start=${ex.start||0}`;
        const ifr=document.createElement("iframe");
        ifr.src=src; ifr.allow="autoplay; encrypted-media; picture-in-picture"; ifr.setAttribute("frameborder","0");
        wrap.appendChild(ifr);
      }
    }else{
      const vid=document.createElement("video");
      vid.controls=true; vid.playsInline=true; vid.preload="metadata";
      vid.src = withBust(resolveAsset(it.video));
      wrap.appendChild(vid);
    }
    card.appendChild(wrap); add(card,secVideos);
  }

  function buildImage(it){
    const card=make('section','card');
    const box=make('div','imgBox');
    const im=new Image(); im.decoding='async'; im.loading='lazy';
    im.src = withBust(resolveAsset(it.url));
    box.appendChild(im);
    const cap=make('div','capBox');
    const h=make('h3','capTitle'); h.textContent=it.title||'';
    const p=make('p','capDesc');  p.textContent=it.desc||'';
    cap.append(h,p);
    card.append(box,cap);
    add(card,secImages);
  }

  /* ===== Ticker (mulus & pasti jalan) ===== */
  let tickerLooping=false, tickerFallback=null;
  function setTickerText(txt){
    tkInner.innerHTML = ""; // reset
    const span=document.createElement('span'); span.className='tkText'; span.textContent = txt || "";
    tkInner.appendChild(span);
    // duplikasi jika total width < viewport, supaya tidak berhenti di tengah
    const ensureFill=()=>{
      const w = tkInner.getBoundingClientRect().width;
      const vw = window.innerWidth;
      if(w < vw*1.2){ // gandakan sampai cukup panjang
        const clone=document.createElement('span'); clone.className='tkText'; clone.textContent="  •  " + (txt||"");
        tkInner.appendChild(clone);
        // ulangi sekali lagi jika masih kurang
        if(tkInner.getBoundingClientRect().width < vw*1.2){
          const clone2=clone.cloneNode(true);
          tkInner.appendChild(clone2);
        }
      }
    };
    ensureFill();
  }
  function startTicker(){
    if(tickerLooping) return; tickerLooping=true;

    const run=()=>{
      tkInner.style.transition="none";
      tkInner.style.transform=`translateX(${window.innerWidth}px)`;
      // force reflow
      void tkInner.offsetHeight;

      const width=tkInner.getBoundingClientRect().width || 0;
      const total=width + window.innerWidth;
      const dur= total / Math.max(50, tickerSpeed); // px per detik
      tkInner.style.transition=`transform ${dur}s linear`;
      tkInner.style.transform=`translateX(-${width}px)`;

      const restart=()=>{ clearTimeout(tickerFallback); tickerFallback=setTimeout(run, Math.max(0,tickerPauseSec)*1000); };
      tkInner.ontransitionend = restart;
      tkInner.ontransitioncancel = restart;

      // Fallback jika event tidak terpicu (mis. tab background)
      clearTimeout(tickerFallback);
      tickerFallback=setTimeout(restart, (dur*1000) + (tickerPauseSec*1000) + 300);
    };

    run();
    document.addEventListener('visibilitychange', ()=>{ if(document.hidden) return; tickerLooping=false; clearTimeout(tickerFallback); startTicker(); });
    window.addEventListener('resize', ()=>{ tickerLooping=false; clearTimeout(tickerFallback); startTicker(); });
  }

  /* ===== Jadwal Sholat ===== */
  const tz="Asia/Jakarta";
  let pTimes=null;
  function parseLcl(hhmm){
    const [H,M]=hhmm.split(":").map(Number);
    const d=new Date(new Date().toLocaleString('en-US',{timeZone:tz}));
    d.setHours(H,M,0,0); return d;
  }
  async function loadPrayer(){
    const today=new Date();
    const y=today.toLocaleString('en-CA',{year:'numeric',timeZone:tz});
    const m=today.toLocaleString('en-CA',{month:'2-digit',timeZone:tz});
    const d=today.toLocaleString('en-CA',{day:'2-digit',timeZone:tz});
    try{
      const r=await fetch(`https://api.myquran.com/v2/sholat/jadwal/1301/${y}/${m}/${d}`,{cache:'no-store'});
      if(r.ok){ const j=await r.json(); const t=j?.data?.jadwal;
        if(t){ pTimes={Fajr:parseLcl(t.subuh), Syuruq:parseLcl(t.terbit), Dhuhr:parseLcl(t.dzuhur), Asr:parseLcl(t.ashar), Maghrib:parseLcl(t.maghrib), Isha:parseLcl(t.isya)}; return true; }
      }
    }catch(_){}
    try{
      const r=await fetch(`https://api.aladhan.com/v1/timingsByCity?city=Jakarta&country=Indonesia&method=3`,{cache:'no-store'});
      if(r.ok){ const j=await r.json(); const t=j?.data?.timings;
        if(t){ pTimes={Fajr:parseLcl(t.Fajr), Syuruq:parseLcl(t.Sunrise), Dhuhr:parseLcl(t.Dhuhr), Asr:parseLcl(t.Asr), Maghrib:parseLcl(t.Maghrib), Isha:parseLcl(t.Isha)}; return true; }
      }
    }catch(_){}
    return false;
  }
  function renderPrayerTable(){
    if(!pTimes){ ptEl.innerHTML='<span style="opacity:.7">Jadwal sholat tidak tersedia</span>'; return; }
    const order=["Fajr","Syuruq","Dhuhr","Asr","Maghrib","Isha"];
    const nameMap={Fajr:"Subuh",Syuruq:"Syuruq",Dhuhr:"Zuhur",Asr:"Asar",Maghrib:"Maghrib",Isha:"Isya"};
    function fmt(d){const hh=String(d.getHours()).padStart(2,"0"),mm=String(d.getMinutes()).padStart(2,"0");return `${hh}:${mm}`;}
    ptEl.innerHTML="";
    order.forEach(k=>{
      const row=make('div','prow');
      const nm=make('div','name'); nm.textContent=nameMap[k];
      const tm=make('div','time'); tm.textContent=fmt(pTimes[k]);
      row.append(nm,tm);
      ptEl.appendChild(row);
    });
  }
  function updateNextHeader(){
    if(!pTimes) return;
    const order=["Fajr","Syuruq","Dhuhr","Asr","Maghrib","Isha"];
    const nameMap={Fajr:"Subuh",Syuruq:"Syuruq",Dhuhr:"Zuhur",Asr:"Asar",Maghrib:"Maghrib",Isha:"Isya"};
    const now=new Date(new Date().toLocaleString('en-US',{timeZone:tz}));
    let nextKey=null;
    for(const k of order){ if(now < pTimes[k]){ nextKey=k; break; } }
    if(!nextKey) nextKey="Fajr";
    const target = pTimes[nextKey] < now ? new Date(pTimes[nextKey].getTime()+86400000) : pTimes[nextKey];
    const diff=target-now;
    const h=String(Math.floor(diff/3600000)).padStart(2,'0');
    const m=String(Math.floor((diff%3600000)/60000)).padStart(2,'0');
    const s=String(Math.floor((diff%60000)/1000)).padStart(2,'0');
    nextEl.textContent="Selanjutnya: "+nameMap[nextKey];
    cdEl.textContent=`${h}:${m}:${s}`;
  }

  /* ===== Config ===== */
  async function fetchConfig(){ try{ const r=await fetch(configUrl,{cache:'no-store'}); if(!r.ok) return null; return await r.json(); }catch(_){ return null; } }
  function applyConfig(cfg){
    // Bersihkan sections
    clear(secSchedule); clear(secFinance); clear(secQuotes); clear(secVideos); clear(secImages);

    // 1) Schedule
    if(Array.isArray(cfg?.schedule) && cfg.schedule.length){ buildSchedule(cfg.schedule); }

    // 2) Finance
    if(cfg?.finance){ buildFinance(cfg.finance); }

    // Klasifikasikan slides
    const imgs=[], quotes=[], videos=[];
    if(Array.isArray(cfg?.slides)){
      cfg.slides.forEach(s=>{
        if(s.quote){ quotes.push({quote:String(s.quote), source:s.source||""}); }
        else if(s.video){
          const vv = String(s.video).trim();
          videos.push({video: /^https?:\/\//i.test(vv) ? vv : withBust(resolveAsset(vv))});
        }
        else if(s.url){
          const uu = String(s.url).trim();
          imgs.push({url: withBust(resolveAsset(uu)), title:s.title||"", desc:s.desc||""});
        }
      });
    }
    // 3) Quotes
    quotes.forEach(buildQuote);
    // 4) Videos
    videos.forEach(buildVideo);
    // 5) Images
    imgs.forEach(buildImage);

    // QRIS dari JSON
    if(cfg?.qris && cfg.qris.src){
      qrisImg.src = withBust(resolveAsset(cfg.qris.src));
      qrisImg.style.width = (cfg.qris.width? Number(cfg.qris.width):88) + "px";
      qrisTtl.textContent = cfg.qris.title || "Dukungan Infaq – Scan QRIS";
      qrisBox.classList.toggle('right', String(cfg.qris.position||"left").toLowerCase()==="right");
      qrisImg.onload = ()=>{ qrisBox.style.display='flex'; };
      qrisImg.onerror=()=>{ qrisBox.style.display='none'; };
      qrisClose.onclick=()=>{ qrisBox.style.display='none'; };
    }else{
      qrisBox.style.display='none';
    }

    // Ticker
    const t = tickerParam ?? cfg?.ticker;
    const s = showTickerQ || !!cfg?.showTicker || !!t;
    if (s && t) {
      ticker.style.display="block";
      // tunggu font agar width akurat
      (document.fonts?document.fonts.ready:Promise.resolve()).then(()=>{
        setTickerText(String(t));
        tickerLooping=false; clearTimeout(tickerFallback);
        startTicker();
      });
    } else {
      ticker.style.display="none";
    }
  }

  /* ===== Utils ===== */
  function formatRupiah(n){
    try{ return new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',maximumFractionDigits:0}).format(n); }
    catch(_){ return "Rp " + (n||0).toString().replace(/\B(?=(\d{3})+(?!\d))/g,'.'); }
  }

  /* ===== Init ===== */
  (async function init(){
    await loadPrayer();
    renderPrayerTable();
    setInterval(()=>{ renderPrayerTable(); updateNextHeader(); }, 1000);

    const conf=await fetchConfig(); applyConfig(conf||{});
    if(refreshMin>0 && configUrl){
      setInterval(async()=>{ const c=await fetchConfig(); if(c) applyConfig(c); }, refreshMin*60*1000);
    }
  })();
})();
</script>
</body>
</html>

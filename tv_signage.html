<script>
(function(){
  const qs=new URLSearchParams(location.search);

  /* ====== Theme via URL ====== */
  (function setTheme(){
    const th=(qs.get("theme")||"emerald").toLowerCase();
    document.body.classList.remove("theme-emerald","theme-gold");
    document.body.classList.add(`theme-${["emerald","gold"].includes(th)?th:"emerald"}`);
  })();

  /* ====== Data sources ====== */
  const configUrl=qs.get("config");
  const refreshMin=parseFloat(qs.get("refreshMin")||"5");
  const imagesParam=qs.get("images");
  const tickerParam=qs.get("ticker");
  const showTicker=["1","true","yes","on"].includes((qs.get("showTicker")||"").toLowerCase());
  const tickerPauseSec = parseFloat(qs.get("tickerPauseSec")||"2");
  const tickerSpeed = parseFloat(qs.get("tickerSpeed")||"120");

  /* ====== Elements ====== */
  const frameA=document.getElementById("frameA");
  const frameB=document.getElementById("frameB");
  const frameC=document.getElementById("frameC");
  const board=document.getElementById("board");
  const quoteOverlay=document.getElementById("quoteOverlay");
  const qtext=document.getElementById("qtext");
  const qsrc=document.getElementById("qsrc");
  const overlay=document.getElementById("prayerOverlay");
  const pName=document.getElementById("pName");
  const pTimer=document.getElementById("pTimer");
  const ticker=document.getElementById("ticker");
  const tickerInner=document.getElementById("tickerInner");
  const tickerText=document.getElementById("tickerText");
  const ptEl=document.getElementById("pt");
  const nextEl=document.getElementById("next");
  const cdEl=document.getElementById("cd");

  /* ====== Slides (image + quote) ====== */
  let slides=[];            // campuran: {url,title,desc,durationSec} | {quote,source,durationSec}
  let imgIdx=[];            // index-index di 'slides' yang bertipe gambar saja
  let aPtr=0,bPtr=1,cPtr=2; // pointer mandiri untuk A/B/C → indeks ke imgIdx
  let tA,tB,tC;
  let showingQuote=false, quoteTimer=null;

  function isImg(item){ return !!item.url; }
  function isQuote(item){ return !!item.quote; }
  function createImg(src){ const i=new Image(); i.src=src; i.decoding="async"; i.loading="eager"; return i; }

  function mountFrame(frame, s){
    frame.innerHTML="";
    const img=createImg(s.url); frame.appendChild(img);
    const cap=document.createElement("div"); cap.className="caption";
    const h=document.createElement("h3"); h.className="cap-title"; h.textContent=s.title||"";
    const p=document.createElement("p"); p.className="cap-desc"; p.textContent=s.desc||"";
    cap.appendChild(h); cap.appendChild(p); frame.appendChild(cap);
    requestAnimationFrame(()=>img.classList.add("show"));
  }

  function schedule(which, dur){
    const fn=()=>cycle(which); const ms=(dur||8)*1000;
    if(which==="A"){clearTimeout(tA);tA=setTimeout(fn,ms);}
    if(which==="B"){clearTimeout(tB);tB=setTimeout(fn,ms);}
    if(which==="C"){clearTimeout(tC);tC=setTimeout(fn,ms);}
  }

  // Tampilkan quote fullscreen & jeda board sepenuhnya
  function showQuoteFullscreen(item, durSec){
    showingQuote=true;
    clearTimeout(tA); clearTimeout(tB); clearTimeout(tC);
    // Sembunyikan board total agar tidak ada “bayangan” gambar di balik quote
    board.style.display="none";
    quoteOverlay.style.display="flex";
    qtext.textContent=item.quote;
    qsrc.textContent=item.source||"";
    clearTimeout(quoteTimer);
    quoteTimer=setTimeout(()=>{
      quoteOverlay.style.display="none";
      board.style.display="grid";
      showingQuote=false;
      // lanjut rotasi lagi tanpa mengubah pointer A/B/C (supaya tidak sinkron)
      cycle("A"); setTimeout(()=>cycle("B"),1000); setTimeout(()=>cycle("C"),2000);
    }, (durSec||10)*1000);
  }

  function nextImage(of){ // of: "A"|"B"|"C" → ambil item gambar untuk frame tsb, geser pointer-nya
    if(imgIdx.length===0) return null;
    if(of==="A"){ const item=slides[ imgIdx[(aPtr%imgIdx.length+imgIdx.length)%imgIdx.length] ]; aPtr=(aPtr+1)%imgIdx.length; return item; }
    if(of==="B"){ const item=slides[ imgIdx[(bPtr%imgIdx.length+imgIdx.length)%imgIdx.length] ]; bPtr=(bPtr+1)%imgIdx.length; return item; }
    const item=slides[ imgIdx[(cPtr%imgIdx.length+imgIdx.length)%imgIdx.length] ]; cPtr=(cPtr+1)%imgIdx.length; return item;
  }

  function cycle(which){
    if(showingQuote) return;
    // Cek apakah slide terdekat berikutnya adalah QUOTE (global) → bila ya, tampilkan & jangan render image dulu.
    // Caranya: lihat pointer “terdepan” di antara aPtr/bPtr/cPtr (sekedar heuristik)
    const ahead = Math.min(aPtr,bPtr,cPtr);
    const globalNext = slides[ imgIdx.length? imgIdx[ahead % imgIdx.length] : 0 ];
    // Kalau slide berikutnya di daftar global ada item QUOTE di urutan slides (bukan imgIdx), kita tetap biarkan frame berjalan;
    // tetapi, agar quote bisa muncul sesuai urutan di 'slides', kita cek di bawah saat applyConfig (lihat pemanggilan initialQuoteCheck).

    // Render satu frame
    const imgItem = nextImage(which);
    if(imgItem){ 
      const dur = Number(imgItem.durationSec||8);
      if(which==="A"){ mountFrame(frameA,imgItem); schedule("A",dur); }
      if(which==="B"){ mountFrame(frameB,imgItem); schedule("B",dur); }
      if(which==="C"){ mountFrame(frameC,imgItem); schedule("C",dur); }
    }
  }

  /* ====== Quote scheduler: tampilkan quote pada giliran mereka ======
     Kita jalan independen dari frame, agar quote tidak “mengambil” pointer frame. */
  let quoteQueue=[]; // [{quote,source,durationSec}]
  let quotePoll=null;
  function startQuotePoll(){
    clearInterval(quotePoll);
    if(quoteQueue.length===0) return;
    quotePoll=setInterval(()=>{
      if(showingQuote) return;
      // Ambil satu quote secara bergiliran
      const q=quoteQueue.shift();
      quoteQueue.push(q);
      showQuoteFullscreen(q, Number(q.durationSec||10));
    }, 12000); // coba tampilkan quote setiap ±12 detik (akan override jika sedang tampil)
  }

  /* ====== Ticker (loop + jeda) ====== */
  function startTicker(){
    tickerInner.style.transition="none";
    tickerInner.style.transform=`translateX(${window.innerWidth}px)`;
    requestAnimationFrame(()=>{
      const width=tickerInner.getBoundingClientRect().width;
      const total=width + window.innerWidth;
      const dur= total / Math.max(60, tickerSpeed);
      tickerInner.style.transition=`transform ${dur}s linear`;
      tickerInner.style.transform=`translateX(-${width}px)`;
      tickerInner.ontransitionend = ()=>{
        setTimeout(startTicker, Math.max(0,tickerPauseSec)*1000);
      };
    });
  }

  /* ====== Jadwal sholat Jakarta + Syuruq + overlay iqomah ====== */
  const tz="Asia/Jakarta";
  let DUR = { Fajr:20, Dhuhr:15, Asr:15, Maghrib:10, Isha:15 }; // menit
  const testPrayer = (qs.get("testPrayer") || "").toLowerCase();
  const testDurationSec = parseInt(qs.get("testDurationSec") || "0", 10);
  const keyMap = { fajr:"Fajr", subuh:"Fajr", dhuhr:"Dhuhr", zuhur:"Dhuhr", dzuhur:"Dhuhr",
                   asr:"Asr", ashar:"Asr", maghrib:"Maghrib", isya:"Isha", isha:"Isha" };

  function currentCountdownWindowTest(){
    if(!testPrayer || !keyMap[testPrayer]) return null;
    const key = keyMap[testPrayer];
    const now = new Date();
    const end = new Date(now.getTime() + (Math.max(testDurationSec,10) * 1000));
    return { key, start: now, end };
  }

  function parseLcl(hm){
    const [H,M]=hm.split(":").map(Number);
    const d=new Date(new Date().toLocaleString('en-US',{timeZone:tz}));
    d.setHours(H, M, 0, 0);
    return d;
  }

  let pTimes=null; // {Fajr, Syuruq, Dhuhr, Asr, Maghrib, Isha} => Date

  async function loadPrayer(){
    const today=new Date();
    const y=today.toLocaleString('en-CA',{year:'numeric',timeZone:tz});
    const m=today.toLocaleString('en-CA',{month:'2-digit',timeZone:tz});
    const d=today.toLocaleString('en-CA',{day:'2-digit',timeZone:tz});
    // MyQuran
    try{
      const r=await fetch(`https://api.myquran.com/v2/sholat/jadwal/1301/${y}/${m}/${d}`,{cache:'no-store'});
      if(r.ok){
        const j=await r.json(); const t=j?.data?.jadwal;
        if(t){
          pTimes={
            Fajr:parseLcl(t.subuh),
            Syuruq:parseLcl(t.terbit),
            Dhuhr:parseLcl(t.dzuhur),
            Asr:parseLcl(t.ashar),
            Maghrib:parseLcl(t.maghrib),
            Isha:parseLcl(t.isya)
          };
          return true;
        }
      }
    }catch(_){}
    // Fallback Aladhan
    try{
      const r=await fetch(`https://api.aladhan.com/v1/timingsByCity?city=Jakarta&country=Indonesia&method=3`,{cache:'no-store'});
      const j=await r.json(); const t=j?.data?.timings;
      if(t){
        pTimes={
          Fajr:parseLcl(t.Fajr),
          Syuruq:parseLcl(t.Sunrise),
          Dhuhr:parseLcl(t.Dhuhr),
          Asr:parseLcl(t.Asr),
          Maghrib:parseLcl(t.Maghrib),
          Isha:parseLcl(t.Isha)
        };
        return true;
      }
    }catch(_){}
    return false;
  }

  function renderPrayerTable(){
    if(!pTimes){ ptEl.innerHTML='<span style="opacity:.7">Jadwal salat tidak tersedia</span>'; return; }
    const order=["Fajr","Syuruq","Dhuhr","Asr","Maghrib","Isha"];
    const nameMap={Fajr:"Subuh",Syuruq:"Syuruq",Dhuhr:"Zuhur",Asr:"Asar",Maghrib:"Maghrib",Isha:"Isya"};
    function fmt(d){ const hh=String(d.getHours()).padStart(2,"0"); const mm=String(d.getMinutes()).padStart(2,"0"); return `${hh}:${mm}`; }
    ptEl.innerHTML="";
    order.forEach(k=>{
      const nm=document.createElement("div"); nm.className="name"; nm.textContent=nameMap[k];
      const tm=document.createElement("div"); tm.className="time"; tm.textContent=fmt(pTimes[k]);
      ptEl.appendChild(nm); ptEl.appendChild(tm);
    });
  }

  function currentCountdownWindow(){
    if(!pTimes) return null;
    const order=["Fajr","Dhuhr","Asr","Maghrib","Isha"]; // tidak ada countdown untuk Syuruq
    const now=new Date(new Date().toLocaleString('en-US',{timeZone:tz}));
    for(const k of order){
      const start=pTimes[k];
      const end=new Date(start.getTime() + (DUR[k]*60*1000));
      if(now>=start && now<end){
        return { key:k, start, end };
      }
    }
    return null;
  }

  function updateNextHeader(){
    if(!pTimes) return;
    const order=["Fajr","Syuruq","Dhuhr","Asr","Maghrib","Isha"];
    const nameMap={Fajr:"Subuh",Syuruq:"Syuruq",Dhuhr:"Zuhur",Asr:"Asar",Maghrib:"Maghrib",Isha:"Isya"};
    const now=new Date(new Date().toLocaleString('en-US',{timeZone:tz}));
    let nextKey=null;
    for(const k of order){ if(now<pTimes[k]){ nextKey=k; break; } }
    if(!nextKey) nextKey="Fajr";
    const target=pTimes[nextKey] < now ? new Date(pTimes[nextKey].getTime()+24*3600*1000) : pTimes[nextKey];
    const diff=target-now;
    const h=String(Math.floor(diff/3600000)).padStart(2,'0');
    const m=String(Math.floor((diff%3600000)/60000)).padStart(2,'0');
    const s=String(Math.floor((diff%60000)/1000)).padStart(2,'0');
    nextEl.textContent="Selanjutnya: "+nameMap[nextKey];
    cdEl.textContent=`${h}:${m}:${s}`;
    Array.from(ptEl.children).forEach((el,i)=>{
      const key=order[Math.floor(i/2)];
      el.style.color = (key===nextKey) ? 'var(--gold)' : '';
    });
  }

  function updateOverlay(){
    const wnd = currentCountdownWindowTest() || currentCountdownWindow();
    if(!wnd){
      overlay.style.display="none";
      if(!showingQuote) { // board hanya tampil jika tidak ada quote
        board.style.display="grid";
        quoteOverlay.style.display="none";
      }
      updateNextHeader();
      return;
    }
    overlay.style.display="flex";
    board.style.display="none";
    quoteOverlay.style.display="none";
    const mapName={Fajr:"Subuh",Dhuhr:"Zuhur",Asr:"Asar",Maghrib:"Maghrib",Isha:"Isya"};
    pName.textContent="Iqomah " + mapName[wnd.key];
    const now=new Date(new Date().toLocaleString('en-US',{timeZone:tz}));
    const rem = wnd.end - now;
    const mm=String(Math.max(0,Math.floor(rem/60000))).padStart(2,'0');
    const ss=String(Math.max(0,Math.floor((rem%60000)/1000))).padStart(2,'0');
    pTimer.textContent = `${mm}:${ss}`;
  }

  /* ====== Config ====== */
  async function fetchConfig(){
    if(!configUrl) return null;
    try{ const r=await fetch(configUrl,{cache:'no-store'}); if(!r.ok) return null; return await r.json(); }
    catch(_){ return null; }
  }
  function applyConfig(cfg){
    // Optional: override durasi iqomah via JSON
    if(cfg?.countdownMinutes){ DUR = Object.assign(DUR, cfg.countdownMinutes); }

    // Build slides
    if(cfg && Array.isArray(cfg.slides)){
      slides = cfg.slides.map(s=>{
        const item={ durationSec:Number(s.durationSec||8) };
        if(s.quote){ item.quote=String(s.quote); item.source=s.source||""; }
        else { item.url=String(s.url||"").trim(); item.title=s.title||""; item.desc=s.desc||""; }
        return item;
      }).filter(s=> s.quote || s.url);
    }else if(imagesParam){
      slides = imagesParam.split(",").map(u=>u.trim()).filter(Boolean).map(u=>({url:u,title:"",desc:"",durationSec:8}));
    }else{
      slides = [
        {url:"https://picsum.photos/seed/a/1600/900",title:"Kegiatan Masjid",desc:"Contoh 1",durationSec:8},
        {quote:"“Sebaik-baik kalian adalah yang mempelajari Al-Qur’an dan mengajarkannya.”", source:"HR. Bukhari", durationSec:12},
        {url:"https://picsum.photos/seed/b/1600/900",title:"Kajian Rutin",desc:"Contoh 2",durationSec:8},
        {url:"https://picsum.photos/seed/c/1600/900",title:"Kerja Bakti",desc:"Contoh 3",durationSec:8}
      ];
    }

    // Siapkan index untuk gambar & quote
    imgIdx = slides.map((s,idx)=> isImg(s)? idx : -1).filter(i=>i>=0);
    const quotes = slides.filter(isQuote);
    quoteQueue = quotes.slice(); // rotasi siklis

    // Inisialisasi pointer A/B/C agar pasti 3 gambar berbeda
    if(imgIdx.length===1){ aPtr=0; bPtr=0; cPtr=0; }
    else if(imgIdx.length===2){ aPtr=0; bPtr=1; cPtr=0; }
    else { aPtr=0; bPtr=1; cPtr=2; }

    // Mulai rotasi frame dan polling quote
    if(imgIdx.length>0){
      cycle("A"); setTimeout(()=>cycle("B"),400); setTimeout(()=>cycle("C"),800);
    }
    startQuotePoll();

    // Ticker
    const t=tickerParam ?? cfg?.ticker; 
    const s=showTicker || !!cfg?.showTicker || !!t;
    if(s && t){ ticker.style.display="flex"; tickerText.textContent=t; startTicker(); } else { ticker.style.display="none"; }
  }

  /* ====== Init ====== */
  (async function init(){
    await loadPrayer(); renderPrayerTable();
    const cfg=await fetchConfig(); applyConfig(cfg);
    if(refreshMin>0 && configUrl){
      setInterval(async()=>{ const c=await fetchConfig(); if(c) applyConfig(c); }, refreshMin*60*1000);
    }
    setInterval(updateOverlay, 1000);
  })();
})();
</script>

<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>TV Signage – Masjid</title>
<style>
  :root{
    --bg1:#E8FFF7; --bg2:#D9F7F0;
    --panel:#F4FBF8; --border:#B6E2D5;
    --gold:#C9A23C; --text:#102A27; --muted:#3A5F58;
    --shadow:0 12px 40px rgba(0,0,0,.16);
    --tickerBg:#0B1C53; --tickerText:#FFFFFF;
  }
  body.theme-emerald{
    --bg1:#0d2d28; --bg2:#134238; --panel:#123a32; --border:#2f6b5e;
    --gold:#e8c15a; --text:#EAF7F3; --muted:#bfe4d8;
    --shadow:0 16px 48px rgba(0,0,0,.28);
    --tickerBg:#0f3b34; --tickerText:#fdfdfd;
  }
  body.theme-gold{
    --bg1:#fff7e0; --bg2:#ffefc6; --panel:#fff8e8; --border:#f0db9a;
    --gold:#d5a921; --text:#2b240f; --muted:#5b4d1d;
    --shadow:0 16px 48px rgba(0,0,0,.18);
    --tickerBg:#7a5a12; --tickerText:#fffaf0;
  }

  html,body{height:100%;margin:0;overflow:hidden;font-family:Inter,"Segoe UI",Roboto,system-ui,Arial,sans-serif}
  body{
    background:
      radial-gradient(1200px 700px at 10% 0%, rgba(36,198,174,.25), transparent 60%),
      radial-gradient(1200px 700px at 90% 10%, rgba(0,184,148,.22), transparent 60%),
      linear-gradient(180deg, var(--bg1), var(--bg2));
  }

  /* TOP BAR */
  .topbar{position:fixed; top:14px; left:16px; right:16px;
    display:grid; grid-template-columns:auto 1fr; gap:16px; z-index:5;}
  .brand{
    display:flex; gap:12px; align-items:center; padding:10px 14px;
    background:linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.10));
    border-radius:14px; box-shadow:var(--shadow);
    border:1px solid var(--border); backdrop-filter: blur(6px);
  }
  .brand img{height:44px;width:auto;display:block}
  .brand-text{display:flex; flex-direction:column; line-height:1.1}
  .brand-name{color:var(--text); font-weight:900; font-size:18px}
  .brand-sub{color:var(--muted); font-weight:700; font-size:13px}

  .pray-wrap{display:flex;justify-content:flex-end}
  .prayer{display:grid;grid-template-columns:auto 1fr auto auto;gap:14px;align-items:center;
    padding:10px 14px;background:linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.10));
    border-radius:14px;box-shadow:var(--shadow);border:1px solid var(--border);min-width:min(72vw,1320px);
    color:var(--text);backdrop-filter: blur(6px)}
  .prayer .heading{font-weight:900}
  .pt{display:grid;grid-template-columns:repeat(6, auto auto);gap:6px 14px}
  .pt .name{color:var(--muted);font-weight:800}
  .pt .time{font-weight:900}
  .next{color:var(--gold);font-weight:900}
  .cd{font-weight:900}

  /* STAGE + BOARD */
  #stage{position:relative;margin:88px 16px 58px; border-radius:22px;
    background:linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
    box-shadow:var(--shadow); overflow:hidden; display:grid; place-items:center; border:1px solid var(--border);
    min-height:min(70vh,820px)}
  #stage.overlay-active #board{display:none !important;}

  .board{display:grid; grid-template-columns:2fr 1fr; gap:22px; width:min(92vw,1680px); height:min(70vh,820px);
    background:linear-gradient(180deg, var(--panel), rgba(0,0,0,.06));
    border-radius:20px; border:1px solid var(--border); box-shadow:inset 0 0 0 2px rgba(255,255,255,.20); padding:22px}
  .frame{position:relative; background:linear-gradient(180deg, rgba(255,255,255,.06), var(--panel));
    border-radius:14px; overflow:hidden; box-shadow:0 8px 24px rgba(0,0,0,.18), inset 0 0 0 2px rgba(255,255,255,.20); border:1px solid var(--border)}
  .stack{display:grid; grid-template-rows:1fr 1fr; gap:22px}
  .frame img{position:absolute; inset:0; width:100%; height:100%; object-fit:cover; opacity:0; transition:opacity .6s}
  .frame img.show{opacity:1}
  .caption{position:absolute; left:14px; right:14px; bottom:14px; padding:12px 14px;
    background:linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.3)); color:#fff; border-radius:10px}
  .cap-title{font-weight:900; font-size:clamp(18px,2vw,26px); margin:0 0 4px}
  .cap-desc{font-weight:600; font-size:clamp(14px,1.4vw,18px); margin:0}

  /* OVERLAYS */
  #quoteOverlay,#videoOverlay,#financeOverlay,#scheduleOverlay,#prayerOverlay{
    position:absolute; inset:0; display:none; align-items:center; justify-content:center; z-index:30;
    background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.85));
  }
  #videoOverlay{ background: rgba(0,0,0,.85); }
  .vbox{
    background:#000; border-radius:16px; box-shadow:0 16px 48px rgba(0,0,0,.5);
    outline:1px solid rgba(255,255,255,.2); overflow:hidden; display:grid; place-items:center;
  }
  #videoOverlay video, #videoOverlay iframe{ width:100%; height:100%; display:block }

  /* Quote fullscreen */
  .qwrap{
    max-width:84%; background:rgba(0,0,0,.45);
    border:1px solid rgba(255,255,255,.22); border-radius:18px; padding:28px 34px; color:var(--gold);
    box-shadow:0 16px 36px rgba(0,0,0,.55)
  }
  .qtext{font-weight:900; font-size:clamp(32px,3.6vw,72px); line-height:1.35; margin:0 0 12px; text-align:center; color:var(--gold); text-shadow:0 3px 8px rgba(0,0,0,.85)}
  .qsrc{font-weight:800; font-size:clamp(18px,2.2vw,32px); margin:0; text-align:center; color:#fff; text-shadow:0 2px 6px rgba(0,0,0,.8)}

  /* Finance */
  .fcard{display:grid; gap:12px; place-items:center; padding:28px 34px; border-radius:22px;
    background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.08)); border:1px solid var(--border); box-shadow:var(--shadow); color:#fff; text-align:center; backdrop-filter:blur(6px)}
  .ftitle{font-weight:900; font-size:clamp(26px,3.4vw,54px); color:var(--gold)}
  #finCanvas{width:min(86vw,1400px); height:min(48vh,520px); background:rgba(0,0,0,.25); border-radius:14px; outline:1px solid rgba(255,255,255,.2)}

  /* Schedule */
  .scard{display:grid; gap:12px; place-items:stretch; padding:28px 34px; border-radius:22px;
    background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.08)); border:1px solid var(--border); box-shadow:var(--shadow); color:#fff; text-align:left; backdrop-filter:blur(6px); width:min(92vw,1500px)}
  .stitle{font-weight:900; font-size:clamp(26px,3.2vw,52px); color:var(--gold); text-align:center}
  .slist{display:grid; gap:12px}
  .srow{
    display:grid;
    grid-template-columns: minmax(260px, 380px) 1fr 1fr;
    gap:16px; padding:14px 16px; border-radius:12px; background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.15)
  }
  .srow .time{  font-weight:900; font-size:clamp(16px,1.9vw,24px) }
  .srow .topic{ font-weight:800; font-size:clamp(16px,1.8vw,22px) }
  .srow .ust{   font-weight:700; font-size:clamp(15px,1.7vw,20px); opacity:.95 }

  /* Iqomah overlay */
  #prayerOverlay{z-index:40; background:linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.65))}
  .pCard{display:grid;gap:12px;place-items:center;padding:30px 40px;border-radius:22px;
    background:linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.10));
    border:1px solid var(--border);box-shadow:var(--shadow);color:#fff;text-align:center;backdrop-filter:blur(6px)}
  .pTitle{font-weight:900;font-size:clamp(28px,3.2vw,56px)}
  .pName{font-weight:900;font-size:clamp(34px,4vw,72px);color:var(--gold)}
  .pTimer{font-weight:900;font-size:clamp(48px,7vw,120px);letter-spacing:1px}

  /* Ticker */
  #ticker{display:none; position:fixed; left:0; right:0; bottom:0; background:var(--tickerBg); color:var(--tickerText); min-height:48px; align-items:center; overflow:hidden}
  #tickerInner{white-space:nowrap; will-change:transform; padding:0 100vw 0 0}
  #tickerText{display:inline-block; padding:12px 28px; font-size:clamp(16px,1.6vw,22px); font-weight:800}

  /* Tablet */
  @media (max-width: 1024px){
    .topbar{ grid-template-columns: 1fr; gap:12px }
    .prayer{ min-width:auto }
    #stage{ margin:84px 12px 56px }
    .board{ grid-template-columns: 1fr; width: 96vw; height: auto; padding:16px; gap:16px }
    .stack{ grid-template-rows: 1fr; grid-template-columns: 1fr; gap:16px }
    .frame{ min-height: 28vh }
    .caption{ left:10px; right:10px; bottom:10px; padding:10px 12px }
  }

  /* Smartphone */
  @media (max-width: 600px){
    .brand{ padding:8px 10px }
    .brand img{ height:36px }
    .brand-name{ font-size:16px }
    .brand-sub{ font-size:12px }
    .prayer{ grid-template-columns: 1fr; gap:8px; padding:8px 10px }
    .pt{ grid-template-columns: repeat(3, auto auto); gap:6px 12px }
    .next,.cd{ justify-self: start }
    #stage{ margin:74px 10px 52px }
    .board{ width: 98vw; padding:12px; gap:12px }
    .frame{ min-height: 26vh }
    .cap-title{ font-size:clamp(16px,4.2vw,22px) }
    .cap-desc{  font-size:clamp(13px,3.5vw,18px) }
    .scard{ padding:18px 16px }
    .srow{ grid-template-columns: 1fr; gap:8px }
    .srow .time{ font-size:clamp(16px,4.3vw,22px) }
    .srow .topic{font-size:clamp(15px,4vw,20px) }
    .srow .ust{  font-size:clamp(14px,3.8vw,18px) }
  }
</style>
</head>
<body class="theme-gold">

<!-- TOP BAR -->
<div class="topbar">
  <div class="brand">
    <img src="logo.png" alt="Logo">
    <div class="brand-text">
      <div class="brand-name">Masjid Baitussalam</div>
      <div class="brand-sub">Premier Estate 3</div>
    </div>
  </div>

  <div class="pray-wrap">
    <div class="prayer">
      <div class="heading">Waktu Sholat</div>
      <div class="pt" id="pt"></div>
      <div class="next" id="next">-</div>
      <div class="cd" id="cd">--:--:--</div>
    </div>
  </div>
</div>

<div id="stage">
  <!-- BOARD -->
  <div class="board" id="board">
    <div class="frame" id="frameA"></div>
    <div class="stack">
      <div class="frame" id="frameB"></div>
      <div class="frame" id="frameC"></div>
    </div>
  </div>

  <!-- OVERLAYS -->
  <div id="quoteOverlay"><div class="qwrap"><p class="qtext" id="qtext"></p><p class="qsrc" id="qsrc"></p></div></div>

  <div id="videoOverlay">
    <div class="vbox" id="vbox">
      <video id="vplayer" playsinline muted></video>
    </div>
  </div>

  <div id="financeOverlay"><div class="fcard"><div class="ftitle" id="ftitle">Laporan Keuangan</div><canvas id="finCanvas"></canvas></div></div>
  <div id="scheduleOverlay"><div class="scard"><div class="stitle">Jadwal Kajian</div><div class="slist" id="slist"></div></div></div>

  <div id="prayerOverlay" style="display:none">
    <div class="pCard">
      <div class="pTitle">Menuju Iqomah</div>
      <div class="pName" id="pName">Sholat</div>
      <div class="pTimer" id="pTimer">--:--</div>
    </div>
  </div>
</div>

<!-- TICKER -->
<div id="ticker"><div id="tickerInner"><span id="tickerText"></span></div></div>

<script>
(function(){
  const qs=new URLSearchParams(location.search);

  /* ===== Theme ===== */
  (function setTheme(){
    const th=(qs.get("theme")||"emerald").toLowerCase();
    document.body.className = `theme-${["emerald","gold"].includes(th)?th:"emerald"}`;
  })();

  /* ===== Params ===== */
  const configUrl=qs.get("config") || "signage.json";
  const refreshMin=parseFloat(qs.get("refreshMin")||"5");
  const imagesParam=qs.get("images");
  const tickerParam=qs.get("ticker");
  const showTickerQ=["1","true","yes","on"].includes((qs.get("showTicker")||"").toLowerCase());
  const tickerPauseSec = parseFloat(qs.get("tickerPauseSec")||"2");
  const tickerSpeed = parseFloat(qs.get("tickerSpeed")||"120");
  const onlyQuoteQ = ["1","true","yes","on"].includes((qs.get("onlyQuote")||"").toLowerCase());

  // test iqomah (opsional)
  const testPrayer=(qs.get("testPrayer")||"").toLowerCase();
  const testDurationSec=parseInt(qs.get("testDurationSec")||"0",10);
  const keyMap={fajr:"Fajr",subuh:"Fajr",dhuhr:"Dhuhr",zuhur:"Dhuhr",dzuhur:"Dhuhr",asr:"Asr",ashar:"Asr",maghrib:"Maghrib",isya:"Isha",isha:"Isha"};

  /* ===== Elements ===== */
  const stage = document.getElementById("stage");
  const frameA=document.getElementById("frameA");
  const frameB=document.getElementById("frameB");
  const frameC=document.getElementById("frameC");
  const board=document.getElementById("board");

  const quoteOverlay=document.getElementById("quoteOverlay");
  const qtext=document.getElementById("qtext");
  const qsrc=document.getElementById("qsrc");

  const videoOverlay=document.getElementById("videoOverlay");
  const vbox=document.getElementById("vbox");
  const vplayer=document.getElementById("vplayer");

  const financeOverlay=document.getElementById("financeOverlay");
  const finCanvas=document.getElementById("finCanvas");
  const ftitle=document.getElementById("ftitle");

  const scheduleOverlay=document.getElementById("scheduleOverlay");
  const slist=document.getElementById("slist");

  const ticker=document.getElementById("ticker");
  const tickerInner=document.getElementById("tickerInner");
  const tickerText=document.getElementById("tickerText");

  // Topbar sholat
  const ptEl   = document.getElementById("pt");
  const nextEl = document.getElementById("next");
  const cdEl   = document.getElementById("cd");

  // Overlay iqomah
  const prayerOverlay = document.getElementById("prayerOverlay");
  const pName = document.getElementById("pName");
  const pTimer = document.getElementById("pTimer");

  /* ===== Data ===== */
  let slides=[],imgs=[],quotes=[],videos=[],finance=null,schedule=[];
  let settings={overlayRotationSec:60,overlayShowSec:12};
  let DUR = { Fajr:20, Dhuhr:15, Asr:15, Maghrib:10, Isha:15 };
  let aPtr=0,bPtr=1,cPtr=2,tA,tB,tC;
  let vPtr=0, qPtr=0;        // <<— rotasi video & quote
  let rotationTimer=null, tickerRunning=false;

  /* ===== URL Resolver & Cache-buster ===== */
  function baseOf(urlStr){
    try{ const u=new URL(urlStr, location.href); u.hash=""; u.search=""; return u.href.replace(/[^/]+$/,""); }
    catch(_){ return ""; }
  }
  const __configBase = baseOf(configUrl);
  function resolveAsset(u){
    if(!u) return "";
    if(/^https?:\/\//i.test(u) || /^data:/i.test(u)) return u;
    if(u.startsWith("/")) return u;
    return __configBase ? (__configBase + u) : u;
  }
  const __imgBust = qs.get("imgBust") || qs.get("t");
  function withBust(u){
    if(!__imgBust) return u;
    try{
      const url=new URL(u, location.href);
      url.searchParams.set("v", __imgBust);
      return url.toString();
    }catch(_){
      return u + (u.includes("?")?"&":"?") + "v=" + encodeURIComponent(__imgBust);
    }
  }

  /* ===== YouTube Iframe API ===== */
  let ytPlayer = null;
  let ytTimeout = null;
  const YT_API = { loaded:false, ready:false, waiting:[] };

  function ensureYouTubeAPI(){
    if (YT_API.loaded) return;
    YT_API.loaded = true;
    const tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.head.appendChild(tag);
    window.onYouTubeIframeAPIReady = function(){
      YT_API.ready = true;
      YT_API.waiting.forEach(fn=>fn());
      YT_API.waiting.length = 0;
    };
  }
  function whenYouTubeReady(cb){
    if (YT_API.ready && window.YT && YT.Player) cb();
    else YT_API.waiting.push(cb);
  }
  function isYouTubeUrl(u){ return /(?:youtube\.com|youtu\.be)/i.test(u||""); }
  function extractYouTube(u){
    try{
      const url=new URL(u);
      let id="", start=0;
      const parseTimeToSec=(t)=>{
        if(!t) return 0;
        if(/^\d+$/.test(t)) return +t;
        let s=0; const h=/(\d+)h/i.exec(t); if(h) s+=+h[1]*3600;
        const m=/(\d+)m/i.exec(t); if(m) s+=+m[1]*60;
        const sc=/(\d+)s/i.exec(t); if(sc) s+=+sc[1];
        return s||0;
      };
      if(url.hostname.includes("youtu.be")){
        id=url.pathname.replace(/^\/+/,"");
        start=parseTimeToSec(url.searchParams.get("t"));
      }else{
        if(url.pathname.startsWith("/watch")){
          id=url.searchParams.get("v")||"";
          start=parseTimeToSec(url.searchParams.get("t"));
        }else if(url.pathname.startsWith("/embed/")){
          id=url.pathname.split("/").pop();
          start=parseTimeToSec(url.searchParams.get("start")||url.searchParams.get("t"));
        }
      }
      return id ? {id, start} : null;
    }catch(_){ return null; }
  }

  /* ===== Overlay Utils (no recursion) ===== */
  function hideAllOverlays(skipVideo){
    quoteOverlay.style.display="none";
    financeOverlay.style.display="none";
    scheduleOverlay.style.display="none";
    prayerOverlay.style.display="none";

    if(!skipVideo){
      try { vplayer.pause(); vplayer.removeAttribute('src'); vplayer.load(); } catch(_){}
      const oldIfr = videoOverlay.querySelector("iframe");
      if (oldIfr) oldIfr.remove();
      if (ytPlayer) { try { ytPlayer.stopVideo(); ytPlayer.destroy(); }catch(_){} ytPlayer=null; }
      if (ytTimeout){ clearTimeout(ytTimeout); ytTimeout=null; }
      videoOverlay.style.display="none";
    }
  }

  function closeVideoOverlay(){
    hideAllOverlays(false);
    stage.classList.remove('overlay-active');
    if(imgs.length>0){
      board.style.display="grid";
      cycle("A"); setTimeout(()=>cycle("B"),400); setTimeout(()=>cycle("C"),800);
    }
  }

  function enterOverlay(){
    stage.classList.add('overlay-active');
    board.style.display="none";
    hideAllOverlays(true);
  }

  function exitOverlay(){
    hideAllOverlays(false);
    stage.classList.remove('overlay-active');
    if(imgs.length>0){
      board.style.display="grid";
      cycle("A"); setTimeout(()=>cycle("B"),400); setTimeout(()=>cycle("C"),800);
    }
  }

  /* ===== Helpers ===== */
  const isImg   = s => !!s.url;
  const isQuote = s => !!s.quote;
  const isVideo = s => !!s.video;

  function createImg(src){
    const i=new Image();
    i.decoding="async"; i.loading="eager";
    i.src = withBust(resolveAsset(src));
    i.onerror = ()=>{ console.warn("[Image] gagal load:", i.src);
      i.style.background="repeating-linear-gradient(45deg, rgba(255,0,0,.2), rgba(255,0,0,.2) 10px, transparent 10px, transparent 20px)";
    };
    return i;
  }
  function mountFrame(frame, s){
    frame.innerHTML="";
    const img=createImg(s.url); frame.appendChild(img);
    const cap=document.createElement("div"); cap.className="caption";
    const h=document.createElement("h3"); h.className="cap-title"; h.textContent=s.title || (s.url? s.url.split("/").pop() : "");
    const p=document.createElement("p"); p.className="cap-desc"; p.textContent=s.desc||"";
    cap.appendChild(h); cap.appendChild(p); frame.appendChild(cap);
    requestAnimationFrame(()=>img.classList.add("show"));
  }
  function nextFrom(arr, ptr){
    if(arr.length===0) return null;
    const i=(ptr==="A"?aPtr:ptr==="B"?bPtr:cPtr)%arr.length;
    const it=arr[i];
    if(ptr==="A") aPtr=(aPtr+1)%arr.length; else if(ptr==="B") bPtr=(bPtr+1)%arr.length; else cPtr=(cPtr+1)%arr.length;
    return it;
  }
  function scheduleFrame(which, dur){
    const fn=()=>cycle(which); const ms=(dur||8)*1000;
    if(which==="A"){clearTimeout(tA);tA=setTimeout(fn,ms);}
    if(which==="B"){clearTimeout(tB);tB=setTimeout(fn,ms);}
    if(which==="C"){clearTimeout(tC);tC=setTimeout(fn,ms);}
  }

  /* ===== Video sizing: 16:9 fit ===== */
  function sizeVideoBox(aspect=16/9){
    const maxW = Math.floor(window.innerWidth * 0.92);
    const maxH = Math.floor(window.innerHeight * 0.72);
    let w = maxW, h = Math.round(w / aspect);
    if (h > maxH) { h = maxH; w = Math.round(h * aspect); }
    vbox.style.width = w + "px";
    vbox.style.height = h + "px";
  }
  window.addEventListener('resize', ()=>sizeVideoBox());

  /* ===== Overlays ===== */
  function showQuoteFullscreen(item, durSec){
    enterOverlay();
    quoteOverlay.style.display="flex";
    qtext.textContent = item.quote || "";
    qsrc.textContent  = item.source || "";
    setTimeout(()=>{ quoteOverlay.style.display="none"; exitOverlay(); }, (durSec||settings.overlayShowSec)*1000);
  }

  async function showVideoFullscreen(item){
    enterOverlay();
    videoOverlay.style.display="flex";

    // bersihkan sisa
    const old = videoOverlay.querySelector("iframe"); if(old) old.remove();
    if(ytTimeout){ clearTimeout(ytTimeout); ytTimeout = null; }
    if(ytPlayer){ try{ ytPlayer.stopVideo(); ytPlayer.destroy(); }catch(_){ } ytPlayer=null; }

    const url = String(item.video||"").trim();
    const dur = Number(item.durationSec || settings.overlayShowSec || 12);

    sizeVideoBox(16/9);

    if(isYouTubeUrl(url)){
      try{ vplayer.pause(); vplayer.removeAttribute('src'); vplayer.load(); }catch(_){}
      ensureYouTubeAPI();
      const ex = extractYouTube(url);
      if(!ex){ videoOverlay.style.display="none"; exitOverlay(); return; }

      const holder = document.createElement('div');
      holder.id = "ytHolder-" + Math.random().toString(36).slice(2);
      holder.style.width = "100%";
      holder.style.height = "100%";
      vbox.innerHTML = ""; vbox.appendChild(holder);

      whenYouTubeReady(()=>{
        ytPlayer = new YT.Player(holder, {
          host: 'https://www.youtube-nocookie.com',
          videoId: ex.id,
          playerVars: {
            origin: location.origin,
            enablejsapi: 1,
            autoplay: 1,
            mute: 1,
            controls: 0,
            rel: 0,
            playsinline: 1,
            modestbranding: 1,
            iv_load_policy: 3,
            cc_load_policy: 1,
            start: ex.start || 0
          },
          events: {
            onReady: (e)=>{
              try { e.target.mute(); e.target.playVideo(); } catch(_){}
              const ifr = vbox.querySelector('iframe');
              if (ifr) ifr.setAttribute('allow', 'autoplay; encrypted-media; picture-in-picture');
            },
            onStateChange: (e)=>{
              if (e.data === YT.PlayerState.ENDED) closeVideoOverlay();
            },
            onError: (_e)=>{ console.warn('[YT] onError — menutup overlay.'); closeVideoOverlay(); }
          }
        });
      });

      if(dur>0){ ytTimeout = setTimeout(()=>{ closeVideoOverlay(); }, Math.max(4,dur)*1000); }

    }else{
      // MP4
      vbox.innerHTML = ""; vbox.appendChild(vplayer);
      vplayer.loop=false; vplayer.muted=true; vplayer.playsInline=true;
      vplayer.src = withBust(resolveAsset(url));
      try{ await vplayer.play(); }catch(_){}

      if(dur>0){
        ytTimeout = setTimeout(()=>{ closeVideoOverlay(); }, Math.max(4,dur)*1000);
        vplayer.onended = null;
      }else{
        vplayer.onended = ()=> closeVideoOverlay();
      }
    }
  }

  function drawFinance(){
    if(!finance) return;
    const c=finCanvas, dpr=window.devicePixelRatio||1, w=c.clientWidth, h=c.clientHeight;
    c.width=Math.floor(w*dpr); c.height=Math.floor(h*dpr);
    const ctx=c.getContext('2d'); ctx.scale(dpr,dpr); ctx.clearRect(0,0,w,h);
    const pad=24, labels=finance.labels||[], data=finance.data||[];
    const maxV=Math.max(1, ...data.map(v=>Math.abs(v)));
    const barW=(w-pad*2)/(labels.length*1.6), gap=barW*0.6, baseY=h-pad-30, scale=(h-pad*2-40)/maxV;

    ctx.strokeStyle="rgba(255,255,255,.2)"; ctx.lineWidth=1; ctx.beginPath();
    for(let i=0;i<=4;i++){ const y=pad+i*((baseY-pad)/4); ctx.moveTo(pad,y); ctx.lineTo(w-pad,y); } ctx.stroke();

    labels.forEach((lab,i)=>{
      const v=data[i]||0, bh=v*scale, x=pad+i*(barW+gap), y=baseY-bh;

      ctx.fillStyle="#e8c15a";
      ctx.fillRect(x,y,barW,bh);

      const labelFont = Math.max(12, Math.round(w/60));
      ctx.fillStyle="#fff"; ctx.font = `${labelFont}px Inter, Arial`; ctx.textAlign="center";
      ctx.fillText(lab, x+barW/2, baseY+16);

      const valueFont = Math.max(14, Math.round(w/50));
      ctx.fillStyle="#e8c15a"; ctx.font = `bold ${valueFont}px Inter, Arial`;
      ctx.fillText(formatRupiah(v), x+barW/2, y-6);
    });
  }
  function showFinance(){
    if(!finance) return;
    enterOverlay();
    financeOverlay.style.display="flex";
    drawFinance();
    setTimeout(()=>{ financeOverlay.style.display="none"; exitOverlay(); }, (finance.durationSec||settings.overlayShowSec)*1000);
  }
  function showSchedule(){
    if(!schedule || schedule.length===0) return;
    enterOverlay();
    scheduleOverlay.style.display="flex";
    slist.innerHTML="";
    schedule.forEach(it=>{
      const row=document.createElement('div'); row.className="srow";
      row.innerHTML=`<div class="time">${it.time||""}</div><div class="topic">${it.topic||""}</div><div class="ust">${it.ustadz||""}</div>`;
      slist.appendChild(row);
    });
    setTimeout(()=>{ scheduleOverlay.style.display="none"; exitOverlay(); }, (settings.overlayShowSec)*1000);
  }

  /* ===== Ticker ===== */
  function startTicker(){
    if(tickerRunning) return;
    tickerRunning=true;
    const run=()=>{
      tickerInner.style.transition="none";
      tickerInner.style.transform=`translateX(${window.innerWidth}px)`;
      requestAnimationFrame(()=>{
        const width=tickerInner.getBoundingClientRect().width;
        const total=width + window.innerWidth;
        const dur= total / Math.max(60, tickerSpeed);
        tickerInner.style.transition=`transform ${dur}s linear`;
        tickerInner.style.transform=`translateX(-${width}px)`;
        tickerInner.ontransitionend = ()=> setTimeout(run, Math.max(0,tickerPauseSec)*1000);
      });
    };
    run();
  }

  /* ===== Frames cycle (gambar) ===== */
  function cycle(which){
    if(onlyQuoteQ || imgs.length===0) return;
    const item = nextFrom(imgs, which);
    if(!item) return;
    const dur = Number(item.durationSec||8);
    if(which==="A"){ mountFrame(frameA,item); scheduleFrame("A",dur); }
    if(which==="B"){ mountFrame(frameB,item); scheduleFrame("B",dur); }
    if(which==="C"){ mountFrame(frameC,item); scheduleFrame("C",dur); }
  }

  /* ===== Jadwal Sholat & Iqomah ===== */
  const tz="Asia/Jakarta";
  let pTimes=null;

  function parseLcl(hhmm){
    const [H,M]=hhmm.split(":").map(Number);
    const d=new Date(new Date().toLocaleString('en-US',{timeZone:tz}));
    d.setHours(H,M,0,0); return d;
  }
  async function loadPrayer(){
    const today=new Date();
    const y=today.toLocaleString('en-CA',{year:'numeric',timeZone:tz});
    const m=today.toLocaleString('en-CA',{month:'2-digit',timeZone:tz});
    const d=today.toLocaleString('en-CA',{day:'2-digit',timeZone:tz});
    try{
      const r=await fetch(`https://api.myquran.com/v2/sholat/jadwal/1301/${y}/${m}/${d}`,{cache:'no-store'});
      if(r.ok){ const j=await r.json(); const t=j?.data?.jadwal;
        if(t){ pTimes={Fajr:parseLcl(t.subuh), Syuruq:parseLcl(t.terbit), Dhuhr:parseLcl(t.dzuhur), Asr:parseLcl(t.ashar), Maghrib:parseLcl(t.maghrib), Isha:parseLcl(t.isya)}; return true; }
      }
    }catch(_){}
    try{
      const r=await fetch(`https://api.aladhan.com/v1/timingsByCity?city=Jakarta&country=Indonesia&method=3`,{cache:'no-store'});
      if(r.ok){ const j=await r.json(); const t=j?.data?.timings;
        if(t){ pTimes={Fajr:parseLcl(t.Fajr), Syuruq:parseLcl(t.Sunrise), Dhuhr:parseLcl(t.Dhuhr), Asr:parseLcl(t.Asr), Maghrib:parseLcl(t.Maghrib), Isha:parseLcl(t.Isha)}; return true; }
      }
    }catch(_){}
    return false;
  }
  function renderPrayerTable(){
    if(!pTimes){ ptEl.innerHTML='<span style="opacity:.7">Jadwal sholat tidak tersedia</span>'; return; }
    const order=["Fajr","Syuruq","Dhuhr","Asr","Maghrib","Isha"];
    const nameMap={Fajr:"Subuh",Syuruq:"Syuruq",Dhuhr:"Zuhur",Asr:"Asar",Maghrib:"Maghrib",Isha:"Isya"};
    function fmt(d){const hh=String(d.getHours()).padStart(2,"0"),mm=String(d.getMinutes()).padStart(2,"0");return `${hh}:${mm}`;}
    ptEl.innerHTML="";
    order.forEach(k=>{
      const nm=document.createElement("div"); nm.className="name"; nm.textContent=nameMap[k];
      const tm=document.createElement("div"); tm.className="time"; tm.textContent=fmt(pTimes[k]);
      ptEl.append(nm,tm);
    });
  }
  function updateNextHeader(){
    if(!pTimes) return;
    const order=["Fajr","Syuruq","Dhuhr","Asr","Maghrib","Isha"];
    const nameMap={Fajr:"Subuh",Syuruq:"Syuruq",Dhuhr:"Zuhur",Asr:"Asar",Maghrib:"Maghrib",Isha:"Isya"};
    const now=new Date(new Date().toLocaleString('en-US',{timeZone:tz}));
    let nextKey=null;
    for(const k of order){ if(now < pTimes[k]){ nextKey=k; break; } }
    if(!nextKey) nextKey="Fajr";
    const target = pTimes[nextKey] < now ? new Date(pTimes[nextKey].getTime()+86400000) : pTimes[nextKey];
    const diff=target-now;
    const h=String(Math.floor(diff/3600000)).padStart(2,'0');
    const m=String(Math.floor((diff%3600000)/60000)).padStart(2,'0');
    const s=String(Math.floor((diff%60000)/1000)).padStart(2,'0');
    nextEl.textContent="Selanjutnya: "+nameMap[nextKey];
    cdEl.textContent=`${h}:${m}:${s}`;
    Array.from(ptEl.children).forEach((el,i)=>{const key=order[Math.floor(i/2)]; el.style.color=(key===nextKey)?'var(--gold)':''});
  }
  function currentIqomahWindow(){
    if(testPrayer && keyMap[testPrayer]){
      const key=keyMap[testPrayer];
      const now=new Date();
      return { key, start:now, end:new Date(now.getTime()+Math.max(testDurationSec,10)*1000) };
    }
    if(!pTimes) return null;
    const order=["Fajr","Dhuhr","Asr","Maghrib","Isha"];
    const now=new Date(new Date().toLocaleString('en-US',{timeZone:tz}));
    for(const k of order){
      const start=pTimes[k];
      const end=new Date(start.getTime() + (DUR[k]||10)*60*1000);
      if(now>=start && now<end){ return { key:k, start, end }; }
    }
    return null;
  }
  function updateIqomahOverlay(){
    const wnd=currentIqomahWindow();
    if(!wnd){
      if(prayerOverlay.style.display!=="none"){ prayerOverlay.style.display="none"; stage.classList.remove('overlay-active'); }
      return;
    }
    stage.classList.add('overlay-active');
    hideAllOverlays(true);
    prayerOverlay.style.display="flex";
    board.style.display="none";
    const mapName={Fajr:"Subuh",Dhuhr:"Zuhur",Asr:"Asar",Maghrib:"Maghrib",Isha:"Isya"};
    pName.textContent="Iqomah "+mapName[wnd.key];
    const now=new Date(new Date().toLocaleString('en-US',{timeZone:tz}));
    const rem = Math.max(0, wnd.end - now);
    const mm  = String(Math.floor(rem/60000)).padStart(2,'0');
    const ss  = String(Math.floor((rem%60000)/1000)).padStart(2,'0');
    pTimer.textContent = `${mm}:${ss}`;
  }

  /* ===== Config ===== */
  async function fetchConfig(){ try{ const r=await fetch(configUrl,{cache:'no-store'}); if(!r.ok) return null; return await r.json(); }catch(_){ return null; } }
  function applyConfig(cfg){
    if(cfg?.settings)  settings = Object.assign(settings, cfg.settings);
    if(cfg?.countdownMinutes) DUR = Object.assign(DUR, cfg.countdownMinutes);

    if(cfg && Array.isArray(cfg.slides)){
      slides = cfg.slides.map(s=>{
        const base={durationSec:Number(s.durationSec||8)};
        if(s.quote){ return {...base, quote:String(s.quote), source:s.source||""}; }
        if(s.video){
          const vv = String(s.video).trim();
          return {...base, video: isYouTubeUrl(vv) ? vv : withBust(resolveAsset(vv))};
        }
        if(s.url){
          const uu = String(s.url).trim();
          return {...base, url: withBust(resolveAsset(uu)), title:s.title||"", desc:s.desc||""};
        }
        return null;
      }).filter(Boolean);
    }else if(imagesParam){
      slides = imagesParam.split(",").map(u=>u.trim()).filter(Boolean)
        .map(u=>({url: withBust(resolveAsset(u)), title:"", desc:"", durationSec:8}));
    }else{
      slides = [];
    }

    imgs   = slides.filter(isImg);
    quotes = slides.filter(isQuote);
    videos = slides.filter(isVideo);

    // Finance & Schedule
    finance  = cfg?.finance || null;
    if(finance && finance.title) ftitle.textContent = finance.title;
    schedule = Array.isArray(cfg?.schedule) ? cfg.schedule : [];

    // Board
    if(!onlyQuoteQ && imgs.length>0){
      stage.classList.remove('overlay-active');
      board.style.display="grid";
      aPtr=0; bPtr=(imgs.length>1?1:0); cPtr=(imgs.length>2?2:(imgs.length>1?0:0));
      cycle("A"); setTimeout(()=>cycle("B"),400); setTimeout(()=>cycle("C"),800);
    }else{
      board.style.display="none";
    }

    // Overlay Rotation (video/finance/schedule/quote) — pakai pointer
    if(rotationTimer){ clearInterval(rotationTimer); rotationTimer=null; }
    const order = (cfg?.overlaysOrder && cfg.overlaysOrder.length) ? cfg.overlaysOrder
                  : ["video","finance","schedule","quote"];
    const rotSec = Math.max(6, Number(settings.overlayRotationSec||60));
    let idx=0;
    rotationTimer=setInterval(()=>{
      if(stage.classList.contains('overlay-active')) return;
      const kind = order[idx%order.length]; idx++;
      if(kind==="video" && videos.length>0){
        showVideoFullscreen(videos[vPtr]); vPtr=(vPtr+1)%videos.length;
      }else if(kind==="finance" && finance){
        showFinance();
      }else if(kind==="schedule" && schedule.length>0){
        showSchedule();
      }else if(kind==="quote" && quotes.length>0){
        const q = quotes[qPtr];
        showQuoteFullscreen(q, Number(q.durationSec||settings.overlayShowSec));
        qPtr=(qPtr+1)%quotes.length;
      }
    }, rotSec*1000);

    // Ticker
    const t = tickerParam ?? cfg?.ticker;
    const s = showTickerQ || !!cfg?.showTicker || !!t;
    if (s && t) {
      ticker.style.display="flex";
      tickerText.textContent=t;
      tickerRunning=false;
      startTicker();
    } else {
      ticker.style.display="none";
    }
  }

  /* ===== Utils ===== */
  function formatRupiah(n){
    try{ return new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',maximumFractionDigits:0}).format(n); }
    catch(_){ return "Rp " + (n||0).toString().replace(/\B(?=(\d{3})+(?!\d))/g,'.'); }
  }

  /* ===== Init ===== */
  (async function init(){
    await loadPrayer();
    renderPrayerTable();
    setInterval(()=>{ renderPrayerTable(); updateNextHeader(); updateIqomahOverlay(); }, 1000);

    const cfg=await fetchConfig(); applyConfig(cfg||{});
    if(refreshMin>0 && configUrl){
      setInterval(async()=>{ const c=await fetchConfig(); if(c) applyConfig(c); }, refreshMin*60*1000);
    }
  })();
})();
</script>
</body>
</html>

<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>TV Signage – Masjid</title>
<style>
  :root{--bg1:#E8FFF7;--bg2:#D9F7F0;--panel:#F4FBF8;--border:#B6E2D5;--gold:#C9A23C;--text:#102A27;--muted:#3A5F58;--shadow:0 12px 40px rgba(0,0,0,.16);--tickerBg:#0B1C53;--tickerText:#FFFFFF}
  body.theme-emerald{--bg1:#0d2d28;--bg2:#134238;--panel:#123a32;--border:#2f6b5e;--gold:#e8c15a;--text:#EAF7F3;--muted:#bfe4d8;--shadow:0 16px 48px rgba(0,0,0,.28);--tickerBg:#0f3b34;--tickerText:#fdfdfd}
  body.theme-gold{--bg1:#fff7e0;--bg2:#ffefc6;--panel:#fff8e8;--border:#f0db9a;--gold:#d5a921;--text:#2b240f;--muted:#5b4d1d;--shadow:0 16px 48px rgba(0,0,0,.18);--tickerBg:#7a5a12;--tickerText:#fffaf0}
  html,body{height:100%;margin:0;overflow:hidden;font-family:Inter,"Segoe UI",Roboto,system-ui,Arial,sans-serif}
  body{background:
      radial-gradient(1200px 700px at 10% 0%, rgba(36,198,174,.25), transparent 60%),
      radial-gradient(1200px 700px at 90% 10%, rgba(0,184,148,.22), transparent 60%),
      linear-gradient(180deg, var(--bg1), var(--bg2));}
  .topbar{position:fixed;top:14px;left:16px;right:16px;display:grid;grid-template-columns:auto 1fr;gap:16px;z-index:5}
  .brand{display:flex;gap:12px;align-items:center;padding:10px 14px;background:linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.10));border-radius:14px;box-shadow:var(--shadow);border:1px solid var(--border);backdrop-filter: blur(6px)}
  .brand img{height:44px;width:auto}
  .brand-text{display:flex;flex-direction:column;line-height:1.1}
  .brand-name{color:var(--text);font-weight:900;font-size:18px}
  .brand-sub{color:var(--muted);font-weight:700;font-size:13px}
  .pray-wrap{display:flex;justify-content:flex-end}
  .prayer{display:grid;grid-template-columns:auto 1fr auto auto;gap:14px;align-items:center;padding:10px 14px;background:linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.10));border-radius:14px;box-shadow:var(--shadow);border:1px solid var(--border);min-width:min(72vw,1320px);color:var(--text);backdrop-filter: blur(6px)}
  .prayer .heading{font-weight:900}
  .pt{display:grid;grid-template-columns:repeat(6, auto auto);gap:6px 14px}
  .pt .name{color:var(--muted);font-weight:800}
  .pt .time{font-weight:900}
  .next{color:var(--gold);font-weight:900}
  .cd{font-weight:900}
  #stage{position:relative;margin:128px 16px 58px;border-radius:22px;background:linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));box-shadow:var(--shadow);overflow:hidden;display:grid;place-items:center;border:1px solid var(--border);min-height:min(70vh,820px)}
  .board{display:grid;grid-template-columns:2fr 1fr;gap:22px;width:min(92vw,1680px);height:min(70vh,820px);background:linear-gradient(180deg, var(--panel), rgba(0,0,0,.06));border-radius:20px;border:1px solid var(--border);box-shadow:inset 0 0 0 2px rgba(255,255,255,.20);padding:22px}
  .frame{position:relative;background:linear-gradient(180deg, rgba(255,255,255,.06), var(--panel));border-radius:14px;overflow:hidden;box-shadow:0 8px 24px rgba(0,0,0,.18), inset 0 0 0 2px rgba(255,255,255,.20);border:1px solid var(--border)}
  .stack{display:grid;grid-template-rows:1fr 1fr;gap:22px}
  .frame img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:0;transition:opacity .6s}
  .frame img.show{opacity:1}
  .caption{position:absolute;left:14px;right:14px;bottom:14px;padding:12px 14px;background:linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.3));color:#fff;border-radius:10px}
  .cap-title{font-weight:900;font-size:clamp(18px,2vw,26px);margin:0 0 4px}
  .cap-desc{font-weight:600;font-size:clamp(14px,1.4vw,18px);margin:0}
  #quoteOverlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;z-index:20}
  .qcard{width:100%;height:100%;display:grid;place-items:center;padding:26px;background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.75))}
  .qwrap{max-width:84%;background:rgba(0,0,0,.50);border:1px solid rgba(255,255,255,.22);border-radius:18px;padding:28px 34px;color:var(--gold);box-shadow:0 16px 36px rgba(0,0,0,.55)}
  .qtext{font-weight:900;font-size:clamp(28px,3.4vw,64px);line-height:1.4;margin:0 0 12px;text-align:center;color:var(--gold);text-shadow:0 3px 8px rgba(0,0,0,.85), 0 1px 0 rgba(0,0,0,.5)}
  .qsrc{font-weight:800;font-size:clamp(18px,2vw,30px);margin:0;text-align:center;color:#fff;text-shadow:0 2px 6px rgba(0,0,0,.8)}
  #videoOverlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;z-index:22;background:rgba(0,0,0,.8)}
  #videoOverlay video{max-width:92vw;max-height:70vh;border-radius:16px;box-shadow:0 16px 48px rgba(0,0,0,.5);outline:1px solid rgba(255,255,255,.2)}
  #financeOverlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;z-index:21}
  .fcard{display:grid;gap:12px;place-items:center;padding:28px 34px;border-radius:22px;background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.08));border:1px solid var(--border);box-shadow:var(--shadow);color:#fff;text-align:center;backdrop-filter:blur(6px)}
  .ftitle{font-weight:900;font-size:clamp(24px,3vw,48px);color:var(--gold)}
  #finCanvas{width:min(86vw,1400px);height:min(48vh,520px);background:rgba(0,0,0,.3);border-radius:14px;outline:1px solid rgba(255,255,255,.2)}
  #scheduleOverlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;z-index:21}
  .scard{display:grid;gap:12px;place-items:stretch;padding:28px 34px;border-radius:22px;background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.08));border:1px solid var(--border);box-shadow:var(--shadow);color:#fff;text-align:left;backdrop-filter:blur(6px);width:min(92vw,1500px)}
  .stitle{font-weight:900;font-size:clamp(24px,3vw,48px);color:var(--gold);text-align:center}
  .slist{display:grid;gap:10px}
  .srow{display:grid;grid-template-columns:120px 1fr 1fr;gap:14px;padding:12px 14px;border-radius:12px;background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.15)}
  .srow .time{font-weight:900}.srow .topic{font-weight:800}.srow .ust{opacity:.95}
  #prayerOverlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.65));z-index:30}
  .pCard{display:grid;gap:12px;place-items:center;padding:30px 40px;border-radius:22px;background:linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.10));border:1px solid var(--border);box-shadow:var(--shadow);color:#fff;text-align:center;backdrop-filter:blur(6px)}
  .pTitle{font-weight:900;font-size:clamp(28px,3.2vw,56px)}
  .pName{font-weight:900;font-size:clamp(34px,4vw,72px);color:var(--gold)}
  .pTimer{font-weight:900;font-size:clamp(48px,7vw,120px);letter-spacing:1px}
  #ticker{display:none;position:fixed;left:0;right:0;bottom:0;background:var(--tickerBg);color:var(--tickerText);min-height:48px;align-items:center;overflow:hidden}
  #tickerInner{white-space:nowrap;will-change:transform;padding:0 100vw 0 0}
  #tickerText{display:inline-block;padding:12px 28px;font-size:clamp(16px,1.6vw,22px);font-weight:800}
</style>
</head>
<body class="theme-emerald">
  <div class="topbar">
    <div class="brand">
      <img src="logo.png" alt="Logo">
      <div class="brand-text">
        <div class="brand-name">Masjid Baitussalam</div>
        <div class="brand-sub">Premier Estate 3</div>
      </div>
    </div>
    <div class="pray-wrap">
      <div class="prayer">
        <div class="heading">Waktu Sholat</div>
        <div class="pt" id="pt"></div>
        <div class="next" id="next">-</div>
        <div class="cd" id="cd">--:--:--</div>
      </div>
    </div>
  </div>

  <div id="stage">
    <div class="board" id="board">
      <div class="frame" id="frameA"></div>
      <div class="stack">
        <div class="frame" id="frameB"></div>
        <div class="frame" id="frameC"></div>
      </div>
    </div>

    <div id="quoteOverlay"><div class="qcard"><div class="qwrap">
      <p class="qtext" id="qtext"></p><p class="qsrc" id="qsrc"></p>
    </div></div></div>

    <div id="videoOverlay"><video id="vplayer" playsinline muted></video></div>

    <div id="financeOverlay"><div class="fcard">
      <div class="ftitle" id="ftitle">Laporan Keuangan Mingguan</div>
      <canvas id="finCanvas"></canvas>
    </div></div>

    <div id="scheduleOverlay"><div class="scard">
      <div class="stitle">Jadwal Kajian</div>
      <div class="slist" id="slist"></div>
    </div></div>

    <div id="prayerOverlay"><div class="pCard">
      <div class="pTitle">Menuju Iqomah</div>
      <div class="pName" id="pName">Sholat</div>
      <div class="pTimer" id="pTimer">--:--</div>
    </div></div>
  </div>

  <div id="ticker"><div id="tickerInner"><span id="tickerText"></span></div></div>

<script>
(function(){
  const qs=new URLSearchParams(location.search);
  (function setTheme(){const th=(qs.get("theme")||"emerald").toLowerCase();document.body.className=`theme-${["emerald","gold"].includes(th)?th:"emerald"}`})();
  const configUrl=qs.get("config");
  const refreshMin=parseFloat(qs.get("refreshMin")||"5");
  const imagesParam=qs.get("images");
  const tickerParam=qs.get("ticker");
  const showTicker=["1","true","yes","on"].includes((qs.get("showTicker")||"").toLowerCase());
  const tickerPauseSec=parseFloat(qs.get("tickerPauseSec")||"2");
  const tickerSpeed=parseFloat(qs.get("tickerSpeed")||"120");
  const onlyQuote=["1","true","yes","on"].includes((qs.get("onlyQuote")||"").toLowerCase());

  const frameA=_("frameA"),frameB=_("frameB"),frameC=_("frameC"),board=_("board");
  const quoteOverlay=_("quoteOverlay"),qtext=_("qtext"),qsrc=_("qsrc");
  const videoOverlay=_("videoOverlay"),vplayer=_("vplayer");
  const financeOverlay=_("financeOverlay"),finCanvas=_("finCanvas"),ftitle=_("ftitle");
  const scheduleOverlay=_("scheduleOverlay"),slist=_("slist");
  const overlay=_("prayerOverlay"),pName=_("pName"),pTimer=_("pTimer");
  const ticker=_("ticker"),tickerInner=_("tickerInner"),tickerText=_("tickerText");
  const ptEl=_("pt"),nextEl=_("next"),cdEl=_("cd");
  function _(id){return document.getElementById(id)}

  let slides=[],imgs=[],quotes=[],videos=[],finance=null,schedule=[];
  let settings={overlayRotationSec:60,overlayShowSec:12};
  let aPtr=0,bPtr=1,cPtr=2,tA,tB,tC,showingQuote=false,quoteTimer=null,quoteLoopTimer=null,overlayTimer=null;

  const isImg=s=>!!s.url,isQuote=s=>!!s.quote,isVideo=s=>!!s.video;
  function createImg(src){const i=new Image();i.src=src;i.decoding="async";i.loading="eager";return i}
  function mountFrame(frame,s){frame.innerHTML="";const img=createImg(s.url);frame.appendChild(img);
    const cap=document.createElement("div");cap.className="caption";
    const h=document.createElement("h3");h.className="cap-title";h.textContent=s.title||"";
    const p=document.createElement("p");p.className="cap-desc";p.textContent=s.desc||"";
    cap.append(h,p);frame.appendChild(cap);requestAnimationFrame(()=>img.classList.add("show"))}
  function nextFrom(arr,ptr){if(arr.length===0)return null;const i=(ptr==="A"?aPtr:ptr==="B"?bPtr:cPtr)%arr.length;
    const it=arr[i];if(ptr==="A")aPtr=(aPtr+1)%arr.length;else if(ptr==="B")bPtr=(bPtr+1)%arr.length;else cPtr=(cPtr+1)%arr.length;return it}
  function scheduleFrame(which,d){const fn=()=>cycle(which),ms=(d||8)*1000;if(which==="A"){clearTimeout(tA);tA=setTimeout(fn,ms)}
    if(which==="B"){clearTimeout(tB);tB=setTimeout(fn,ms)}if(which==="C"){clearTimeout(tC);tC=setTimeout(fn,ms)}}

  function showQuoteFullscreen(item,d){showingQuote=true;clearTimeout(tA);clearTimeout(tB);clearTimeout(tC);hideAllOverlays();
    board.style.display="none";quoteOverlay.style.display="flex";qtext.textContent=item.quote||"";qsrc.textContent=item.source||"";
    clearTimeout(quoteTimer);quoteTimer=setTimeout(()=>{quoteOverlay.style.display="none";showingQuote=false;
      if(overlay.style.display!=="flex"&&imgs.length>0){board.style.display="grid";cycle("A");setTimeout(()=>cycle("B"),400);setTimeout(()=>cycle("C"),800)}},(d||settings.overlayShowSec)*1000)}
  function queueQuotesLoop(){clearTimeout(quoteLoopTimer);if(quotes.length===0)return;quoteLoopTimer=setTimeout(()=>{
    if(showingQuote||overlay.style.display==="flex"||videoOverlay.style.display==="flex"){queueQuotesLoop();return}
    const q=quotes.shift();quotes.push(q);showQuoteFullscreen(q,Number(q.durationSec||settings.overlayShowSec));queueQuotesLoop()
  },settings.overlayRotationSec*1000)}

  async function showVideoFullscreen(item){hideAllOverlays();board.style.display="none";videoOverlay.style.display="flex";vplayer.src=item.video;vplayer.loop=false;vplayer.muted=true;try{await vplayer.play()}catch(_){}
    vplayer.onended=()=>{videoOverlay.style.display="none";if(imgs.length>0){board.style.display="grid";cycle("A");setTimeout(()=>cycle("B"),400);setTimeout(()=>cycle("C"),800)}queueOverlayRotation()};}

  function drawFinance(){if(!finance)return;const c=finCanvas,dpr=window.devicePixelRatio||1,w=c.clientWidth,h=c.clientHeight;c.width=Math.floor(w*dpr);c.height=Math.floor(h*dpr);
    const ctx=c.getContext('2d');ctx.scale(dpr,dpr);ctx.clearRect(0,0,w,h);const pad=24,labels=finance.labels||[],data=finance.data||[];
    const maxV=Math.max(1,...data.map(v=>Math.abs(v))),barW=(w-pad*2)/(labels.length*1.6),gap=barW*0.6,baseY=h-pad-30,scale=(h-pad*2-40)/maxV;
    ctx.strokeStyle="rgba(255,255,255,.2)";ctx.lineWidth=1;ctx.beginPath();for(let i=0;i<=4;i++){const y=pad+i*((baseY-pad)/4);ctx.moveTo(pad,y);ctx.lineTo(w-pad,y)}ctx.stroke();
    ctx.fillStyle="#e8c15a";labels.forEach((lab,i)=>{const v=data[i]||0,bh=v*scale,x=pad+i*(barW+gap),y=baseY-bh;ctx.fillRect(x,y,barW,bh);
      ctx.fillStyle="#fff";ctx.font="12px Inter, Arial";ctx.textAlign="center";ctx.fillText(lab,x+barW/2,baseY+16);
      ctx.fillStyle="#e8c15a";ctx.font="bold 14px Inter, Arial";ctx.fillText(formatRupiah(v),x+barW/2,y-6)})}
  function showFinance(){
  if(!finance) return;
  hideAllOverlays();
  board.style.display = "none";   // pastikan board hilang
  financeOverlay.style.display = "flex";
  drawFinance();
  setTimeout(()=>{
    financeOverlay.style.display = "none";
    if(imgs.length>0){
      board.style.display = "grid";
      cycle("A"); setTimeout(()=>cycle("B"),400); setTimeout(()=>cycle("C"),800);
    }
    queueOverlayRotation();
  }, (finance.durationSec||settings.overlayShowSec)*1000);
}

  function showSchedule(){
  if(!schedule || schedule.length===0) return;
  hideAllOverlays();
  board.style.display = "none";   // pastikan board hilang
  scheduleOverlay.style.display = "flex";
  slist.innerHTML="";
  schedule.forEach(it=>{
    const row=document.createElement('div');
    row.className="srow";
    ['time','topic','ustadz'].forEach((k,idx)=>{
      const d=document.createElement('div');
      d.className=idx===0?'time':idx===1?'topic':'ust';
      d.textContent=it[k]||"";
      row.appendChild(d);
    });
    slist.appendChild(row);
  });
  setTimeout(()=>{
    scheduleOverlay.style.display = "none";
    if(imgs.length>0){
      board.style.display = "grid";
      cycle("A"); setTimeout(()=>cycle("B"),400); setTimeout(()=>cycle("C"),800);
    }
    queueOverlayRotation();
  }, (settings.overlayShowSec)*1000);
}


  const overlayQueue=[];function queueOverlayRotation(){clearTimeout(overlayTimer);if(overlayQueue.length===0)return;
    overlayTimer=setTimeout(()=>{if(overlay.style.display==="flex"||videoOverlay.style.display==="flex"){queueOverlayRotation();return}
      const kind=overlayQueue.shift();overlayQueue.push(kind);
      if(kind==="quote"&&quotes.length>0){const q=quotes.shift();quotes.push(q);showQuoteFullscreen(q,Number(q.durationSec||settings.overlayShowSec))}
      else if(kind==="video"&&videos.length>0){const v=videos.shift();videos.push(v);showVideoFullscreen(v)}
      else if(kind==="finance"&&finance){showFinance()}
      else if(kind==="schedule"&&schedule.length>0){showSchedule()}
      else{queueOverlayRotation()}},settings.overlayRotationSec*1000)}
  function hideAllOverlays(){quoteOverlay.style.display="none";videoOverlay.style.display="none";financeOverlay.style.display="none";scheduleOverlay.style.display="none"}

  function cycle(which){if(showingQuote||imgs.length===0||onlyQuote)return;const item=nextFrom(imgs,which);if(!item)return;const dur=Number(item.durationSec||8);
    if(which==="A"){mountFrame(frameA,item);scheduleFrame("A",dur)}if(which==="B"){mountFrame(frameB,item);scheduleFrame("B",dur)}if(which==="C"){mountFrame(frameC,item);scheduleFrame("C",dur)}}

  function startTicker(){tickerInner.style.transition="none";tickerInner.style.transform=`translateX(${window.innerWidth}px)`;
    requestAnimationFrame(()=>{const width=tickerInner.getBoundingClientRect().width,total=width+window.innerWidth,dur= total/Math.max(60,tickerSpeed);
      tickerInner.style.transition=`transform ${dur}s linear`;tickerInner.style.transform=`translateX(-${width}px)`;
      tickerInner.ontransitionend=()=>setTimeout(startTicker,Math.max(0,tickerPauseSec)*1000)})}

  const tz="Asia/Jakarta";let DUR={Fajr:20,Dhuhr:15,Asr:15,Maghrib:10,Isha:15};
  const testPrayer=(qs.get("testPrayer")||"").toLowerCase(),testDurationSec=parseInt(qs.get("testDurationSec")||"0",10);
  const keyMap={fajr:"Fajr",subuh:"Fajr",dhuhr:"Dhuhr",zuhur:"Dhuhr",dzuhur:"Dhuhr",asr:"Asr",ashar:"Asr",maghrib:"Maghrib",isya:"Isha",isha:"Isha"};
  function parseLcl(hm){const[H,M]=hm.split(":").map(Number);const d=new Date(new Date().toLocaleString('en-US',{timeZone:tz}));d.setHours(H,M,0,0);return d}
  let pTimes=null;
  async function loadPrayer(){
    const today=new Date();const y=today.toLocaleString('en-CA',{year:'numeric',timeZone:tz});
    const m=today.toLocaleString('en-CA',{month:'2-digit',timeZone:tz});const d=today.toLocaleString('en-CA',{day:'2-digit',timeZone:tz});
    try{const r=await fetch(`https://api.myquran.com/v2/sholat/jadwal/1301/${y}/${m}/${d}`,{cache:'no-store'});
      if(r.ok){const j=await r.json();const t=j?.data?.jadwal;if(t){pTimes={Fajr:parseLcl(t.subuh),Syuruq:parseLcl(t.terbit),Dhuhr:parseLcl(t.dzuhur),Asr:parseLcl(t.ashar),Maghrib:parseLcl(t.maghrib),Isha:parseLcl(t.isya)};return true}}}catch(_){}
    try{const r=await fetch(`https://api.aladhan.com/v1/timingsByCity?city=Jakarta&country=Indonesia&method=3`,{cache:'no-store'});
      const j=await r.json();const t=j?.data?.timings;if(t){pTimes={Fajr:parseLcl(t.Fajr),Syuruq:parseLcl(t.Sunrise),Dhuhr:parseLcl(t.Dhuhr),Asr:parseLcl(t.Asr),Maghrib:parseLcl(t.Maghrib),Isha:parseLcl(t.Isha)};return true}}catch(_){}
    return false}
  function renderPrayerTable(){if(!pTimes){ptEl.innerHTML='<span style="opacity:.7">Jadwal salat tidak tersedia</span>';return}
    const order=["Fajr","Syuruq","Dhuhr","Asr","Maghrib","Isha"],nameMap={Fajr:"Subuh",Syuruq:"Syuruq",Dhuhr:"Zuhur",Asr:"Asar",Maghrib:"Maghrib",Isha:"Isya"};
    function fmt(d){const hh=String(d.getHours()).padStart(2,"0"),mm=String(d.getMinutes()).padStart(2,"0");return `${hh}:${mm}`}
    ptEl.innerHTML="";order.forEach(k=>{const nm=document.createElement("div");nm.className="name";nm.textContent=nameMap[k];const tm=document.createElement("div");tm.className="time";tm.textContent=fmt(pTimes[k]);ptEl.append(nm,tm)})}
  function currentCountdownWindowTest(){if(!testPrayer||!keyMap[testPrayer])return null;const key=keyMap[testPrayer];const now=new Date();const end=new Date(now.getTime()+Math.max(testDurationSec,10)*1000);return{key,start:now,end}}
  function currentCountdownWindow(){if(!pTimes)return null;const order=["Fajr","Dhuhr","Asr","Maghrib","Isha"];const now=new Date(new Date().toLocaleString('en-US',{timeZone:tz}));
    for(const k of order){const start=pTimes[k];const end=new Date(start.getTime()+DUR[k]*60*1000);if(now>=start&&now<end){return{key:k,start,end}}}return null}
  function updateNextHeader(){if(!pTimes)return;const order=["Fajr","Syuruq","Dhuhr","Asr","Maghrib","Isha"],nameMap={Fajr:"Subuh",Syuruq:"Syuruq",Dhuhr:"Zuhur",Asr:"Asar",Maghrib:"Maghrib",Isha:"Isya"};
    const now=new Date(new Date().toLocaleString('en-US',{timeZone:tz}));let nextKey=null;for(const k of order){if(now<pTimes[k]){nextKey=k;break}}if(!nextKey)nextKey="Fajr";
    const target=pTimes[nextKey]<now?new Date(pTimes[nextKey].getTime()+86400000):pTimes[nextKey];const diff=target-now;
    const h=String(Math.floor(diff/3600000)).padStart(2,'0'),m=String(Math.floor((diff%3600000)/60000)).padStart(2,'0'),s=String(Math.floor((diff%60000)/1000)).padStart(2,'0');
    nextEl.textContent="Selanjutnya: "+nameMap[nextKey];cdEl.textContent=`${h}:${m}:${s}`;
    Array.from(ptEl.children).forEach((el,i)=>{const key=order[Math.floor(i/2)];el.style.color=(key===nextKey)?'var(--gold)':''})}
  function updateOverlay(){const wnd=currentCountdownWindowTest()||currentCountdownWindow();if(!wnd){overlay.style.display="none";if(!showingQuote&&!onlyQuote&&imgs.length>0){board.style.display="grid"}return}
    overlay.style.display="flex";board.style.display="none";quoteOverlay.style.display="none";videoOverlay.style.display="none";financeOverlay.style.display="none";scheduleOverlay.style.display="none";
    const mapName={Fajr:"Subuh",Dhuhr:"Zuhur",Asr:"Asar",Maghrib:"Maghrib",Isha:"Isya"};pName.textContent="Iqomah "+mapName[wnd.key];
    const now=new Date(new Date().toLocaleString('en-US',{timeZone:tz}));const rem=wnd.end-now;const mm=String(Math.max(0,Math.floor(rem/60000))).padStart(2,'0');const ss=String(Math.max(0,Math.floor((rem%60000)/1000))).padStart(2,'0');pTimer.textContent=`${mm}:${ss}`}

  async function fetchConfig(){if(!configUrl)return null;try{const r=await fetch(configUrl,{cache:'no-store'});if(!r.ok)return null;return await r.json()}catch(_){return null}}
  function applyConfig(cfg){
    if(cfg?.countdownMinutes){DUR=Object.assign(DUR,cfg.countdownMinutes)}
    if(cfg?.settings){settings=Object.assign(settings,cfg.settings)}

    if(cfg && Array.isArray(cfg.slides)){
      slides=cfg.slides.map(s=>{const base={durationSec:Number(s.durationSec||8)};if(s.quote){return{...base,quote:String(s.quote),source:s.source||""}}
        if(s.video){return{...base,video:String(s.video)}} if(s.url){return{...base,url:String(s.url).trim(),title:s.title||"",desc:s.desc||""}} return null}).filter(Boolean)
    }else if(imagesParam){
      slides=imagesParam.split(",").map(u=>u.trim()).filter(Boolean).map(u=>({url:u,title:"",desc:"",durationSec:8}))
    }else{
      slides=[]; // biar rescue mode aktif jika config tidak ada
    }

    imgs=slides.filter(isImg);quotes=slides.filter(isQuote);videos=slides.filter(isVideo);

    /* === RESCUE MODE: jangan biarkan benar-benar kosong === */
    if(!slides || slides.length===0){
      slides=[
        {quote:"“Sebaik-baik kalian adalah yang mempelajari Al-Qur’an dan mengajarkannya.”",source:"HR. Bukhari",durationSec:12},
        {url:"https://picsum.photos/seed/a/1600/900",title:"Kegiatan Masjid",desc:"Contoh 1",durationSec:8},
        {url:"https://picsum.photos/seed/b/1600/900",title:"Kajian Rutin",desc:"Contoh 2",durationSec:8}
      ];
      imgs=slides.filter(isImg);quotes=slides.filter(isQuote);videos=slides.filter(isVideo);
    }

    finance=cfg?.finance||null; if(finance&&finance.title) ftitle.textContent=finance.title;
    schedule=Array.isArray(cfg?.schedule)?cfg.schedule:[];
    overlayQueue.length=0;(cfg?.overlaysOrder||["quote","video","schedule","finance"]).forEach(k=>{if(["quote","video","schedule","finance"].includes(k))overlayQueue.push(k)})

    if(!onlyQuote&&imgs.length>0){board.style.display="grid";aPtr=0;bPtr=(imgs.length>1?1:0);cPtr=(imgs.length>2?2:(imgs.length>1?0:0));
      cycle("A");setTimeout(()=>cycle("B"),400);setTimeout(()=>cycle("C"),800)}else{board.style.display=onlyQuote?"none":"none"}

    if(quotes.length>0){const firstQ=quotes.shift();quotes.push(firstQ);showQuoteFullscreen(firstQ,Number(firstQ.durationSec||settings.overlayShowSec))}
    queueQuotesLoop();queueOverlayRotation();

    /* === TICKER BLOCK (PASTIKAN ADA DI SINI) === */
    const t = tickerParam ?? cfg?.ticker;
    const s = showTicker || !!cfg?.showTicker || !!t;
    if (s && t) { ticker.style.display="flex"; tickerText.textContent=t; startTicker(); }
    else { ticker.style.display="none"; }
  }

  function formatRupiah(n){try{return new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',maximumFractionDigits:0}).format(n)}catch(_){return "Rp "+(n||0).toString().replace(/\B(?=(\d{3})+(?!\d))/g,'.')}}
  (async function init(){
    await loadPrayer();renderPrayerTable();setInterval(()=>{renderPrayerTable();updateNextHeader()},1000);
    const cfg=await fetchConfig();applyConfig(cfg||{});
    if(refreshMin>0&&configUrl){setInterval(async()=>{const c=await fetchConfig();if(c)applyConfig(c)},refreshMin*60*1000)}
    setInterval(updateOverlay,1000);
  })();
})();
</script>
</body>
</html>

<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>TV Signage â€“ Masjid</title>
<style>
  html,body{height:100%;margin:0;background:#000;overflow:hidden;
    font-family:Inter,"Segoe UI",Roboto,system-ui,Arial,sans-serif}
  #stage{position:fixed;inset:0;background:#000;display:flex;align-items:center;justify-content:center}
  .slide{position:absolute;inset:0;opacity:0;transition:opacity .6s ease}
  .slide.show{opacity:1}
  .slide img{width:100%;height:100%;object-fit:cover}
  #ticker{position:fixed;bottom:0;left:0;right:0;background:#0B1C53;
    color:#fff;min-height:42px;display:none;align-items:center;overflow:hidden}
  #tickerInner{white-space:nowrap;will-change:transform;padding:0 100vw 0 0}
  #tickerText{display:inline-block;padding:10px 24px;font-size:20px}
</style>
</head>
<body>
  <div id="stage"></div>
  <div id="ticker"><div id="tickerInner"><span id="tickerText"></span></div></div>

<script>
(function(){
  const qs=new URLSearchParams(location.search);
  const stage=document.getElementById("stage");
  const ticker=document.getElementById("ticker");
  const tickerInner=document.getElementById("tickerInner");
  const tickerText=document.getElementById("tickerText");

  const imagesParam=qs.get("images");       // daftar gambar
  const configUrl=qs.get("config");         // url JSON
  const refreshMin=parseFloat(qs.get("refreshMin")||"0");
  const tickerParam=qs.get("ticker");
  const showTicker=["1","true","yes","on"].includes((qs.get("showTicker")||"").toLowerCase());

  let slides=[]; let idx=0; let timer=null;

  function createSlide(url){
    const d=document.createElement("div");
    d.className="slide";
    const i=document.createElement("img");
    i.src=url; i.loading="eager"; d.appendChild(i);
    stage.appendChild(d);
    return d;
  }

  function showSlide(i){
    const all=[...stage.querySelectorAll(".slide")];
    all.forEach((el,k)=>el.classList.toggle("show",k===i));
  }

  function scheduleNext(){
    clearTimeout(timer);
    if(slides.length===0) return;
    const dur=slides[idx].durationSec||8;
    timer=setTimeout(()=>{
      idx=(idx+1)%slides.length;
      showSlide(idx);
      scheduleNext();
    },dur*1000);
  }

  async function fetchConfig(){
    if(!configUrl) return null;
    try{
      const r=await fetch(configUrl,{cache:"no-store"});
      if(!r.ok) return null;
      return await r.json();
    }catch(e){return null;}
  }

  function applyConfig(cfg){
    stage.innerHTML="";
    slides=[];

    if(cfg && Array.isArray(cfg.slides)){
      slides=cfg.slides.map(s=>({url:s.url,durationSec:Number(s.durationSec||8)}));
    }else if(imagesParam){
      slides=imagesParam.split(",").map(u=>({url:u.trim(),durationSec:8}));
    }else{
      // demo
      slides=[
        {url:"https://picsum.photos/seed/a/1280/720",durationSec:8},
        {url:"https://picsum.photos/seed/b/1280/720",durationSec:8}
      ];
    }

    slides.forEach(s=>createSlide(s.url));
    idx=0; showSlide(idx); scheduleNext();

    const t=tickerParam ?? cfg?.ticker;
    const s=showTicker || cfg?.showTicker;
    if(s && t){ ticker.style.display="flex"; tickerText.textContent=t; startTicker(); }
    else ticker.style.display="none";
  }

  function startTicker(){
    tickerInner.style.transition="none";
    tickerInner.style.transform="translateX(100vw)";
    requestAnimationFrame(()=>{
      const total=tickerInner.getBoundingClientRect().width+window.innerWidth;
      const dur=total/60;
      tickerInner.style.transition=`transform ${dur}s linear`;
      tickerInner.style.transform=`translateX(-${total}px)`;
      tickerInner.ontransitionend=startTicker;
    });
  }

  (async function init(){
    const cfg=await fetchConfig();
    applyConfig(cfg);
    if(refreshMin>0 && configUrl){
      setInterval(async()=>{
        const c=await fetchConfig();
        if(c) applyConfig(c);
      },refreshMin*60000);
    }
  })();
})();
</script>
</body>
</html>
